<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title></title>
  <script>
    // Redirect policy:
    // - If user is signed in (sessionStorage or localStorage 'cssu_logged_user'), allow access.
    // - If site is opened on a GitHub Pages domain (hostname contains 'github.io'), force redirect to login.html
    //   unless already signed in or already on the login page.
    try {
      const s = sessionStorage.getItem('cssu_logged_user');
      const l = localStorage.getItem('cssu_logged_user');
      const isLogged = !!(s || l);
      const onLoginPage = /login\.html$/i.test(window.location.pathname);
      const host = (window.location.hostname || '').toLowerCase();
      const isGithubPages = host.includes('github.io');

      if (!isLogged && !onLoginPage && isGithubPages) {
        // Force visitors on GitHub Pages to see the login page first
        window.location.replace('login.html');
      } else if (!isLogged && !onLoginPage && !isGithubPages) {
        // For non-GitHub hosts, keep default behaviour: allow access only when logged in
        // (If you want to also force login on all domains, change this to always redirect.)
        window.location.replace('login.html');
      }
    } catch (e) { /* ignore in non-browser contexts */ }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }

    body {
      display: flex;
      min-height: 100vh;
      background: #f5f6fa;
    }

    /* Sidebar */
    .sidebar {
      width: 250px;
      background: #2f3640;
      color: #f5f6fa;
      padding: 20px;
      position: fixed;
      height: 100%;
      transition: 0.3s ease;
    }

    .sidebar h2 {
      text-align: center;
      margin-bottom: 40px;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 12px; /* consistent vertical spacing between items */
    }

    .sidebar ul li {
      margin: 0; /* spacing handled by gap on the ul */
    }

    .sidebar ul li a {
      color: #f5f6fa;
      text-decoration: none;
      display: flex;              /* align icon + label */
      align-items: center;
      gap: 12px;                 /* horizontal gap between icon and text */
      padding: 10px 15px;
      border-radius: 8px;
      transition: background 0.3s;
    }

    .sidebar ul li a:hover {
      background: #40739e;
    }

    /* Sidebar submenu */
    .nav .submenu { list-style:none; margin:8px 0 0 8px; padding-left:0; display:none }
    .nav .submenu li { margin:6px 0 }
    .nav .submenu li a { padding:6px 10px; display:block; border-radius:6px; color:#e7f0f7 }
    .nav .has-submenu > a { cursor:pointer }

    /* Main content */
    .main {
      margin-left: 250px;
      flex: 1;
      padding: 20px;
      transition: 0.3s;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 10px 16px; /* tightened */
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-radius: 10px;
      margin-bottom: 12px;
      position: relative; /* allow absolute centering of the inner title */
    }

    .topbar h1 {
      font-size: 22px;
      color: #2f3640;
    }

    .toggle-btn {
      display: none;
      font-size: 22px;
      cursor: pointer;
      color: #2f3640;
    }

    /* Cards */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: start;
    }

    .card h3 {
      margin-bottom: 10px;
      color: #40739e;
    }

    .card p {
      font-size: 18px;
      font-weight: 600;
      color: #2f3640;
    }

    /* Announcements */
    .announcements-card { text-align: left; padding: 16px; margin-bottom: 16px }
    .ann-controls { display:flex; gap:8px; margin-bottom:12px }
    .ann-controls input { flex:1; padding:10px; border-radius:8px; border:1px solid #e6e9ee }
    .ann-controls button { padding:8px 12px; background:#40739e; color:#fff; border:none; border-radius:8px }
    .announcement-list { list-style:none; padding-left:0 }
    .announcement-list li { padding:10px; border-radius:8px; background:#fbfdff; border:1px solid #eef3f6; margin-bottom:8px; display:flex; justify-content:space-between; gap:8px }
    .announcement-actions button { padding:6px 8px; border-radius:6px; border:none; cursor:pointer }
    .announcement-actions .edit { background:#f7fbfd; border:1px solid #d9e3ea }
    .announcement-actions .del { background:#ffefef; border:1px solid #ffd6d6; color:#c0392b }

    /* To-Do Board */
    .todo-board {
      background: white;
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin: 20px 0;
    }

    .todo-board h3 { color: #2f3640; margin-bottom: 12px; }

  .todo-progress { display:flex; align-items:center; gap:12px; margin-bottom:12px }
  .progress-bar { flex:1; height:12px; background:#eef3f6; border-radius:8px; overflow:hidden; }
  .progress-fill { height:100%; width:0%; background: linear-gradient(90deg,#2ecc71,#f1c40f); transition: width 300ms ease; }
  .progress-text { min-width:48px; text-align:right; font-weight:600; color:#2f3640 }

  /* Modal (edit task) */
  .modal { position: fixed; inset: 0; display: none; z-index: 2000; }
  /* When visible, show a fixed backdrop and center the content using fixed positioning
    This avoids flexbox centering issues across different layout contexts and ensures
    the dialog always appears centered in the viewport. */
  .modal[aria-hidden="false"] { display: block; }
  .modal-backdrop { position: fixed; inset: 0; background: rgba(16,24,40,0.25); z-index: 2000; }
  .modal-content { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: #ffffff; padding: 20px; border-radius: 12px; width: 360px; max-width: calc(100% - 40px); box-shadow: 0 12px 30px rgba(16,24,40,0.08); border: 1px solid #eef3f8; z-index: 2001; }
  .modal-content h4 { margin-bottom: 8px; color:#0f172a }
  .modal-content p { color:#475569 }
  .modal-content input { width: 100%; padding:8px 10px; margin-bottom:10px; border-radius:8px; border:1px solid #e6eef6 }
  .modal-actions { display:flex; gap:8px; justify-content:flex-end }
  .modal-actions button { padding:8px 12px; border-radius:8px; border:none; color:white }
  .modal-actions .primary { background:#2563EB }
  .modal-actions .secondary { background:#bdc3c7; color:#0f172a }
  .modal-actions .danger { background: #ef4444 }

    .todo-controls { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
    .todo-controls input[type="text"] {
      flex: 1;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #e6e9ee;
      outline: none;
    }
    .todo-controls button {
      padding: 8px 10px;
      background: #40739e;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
    }

    #importFile { display: none; }

    .columns {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .column {
      background: #fbfdff;
      border: 1px solid #eef3f6;
      padding: 12px;
      border-radius: 8px;
      min-height: 120px;
    }

    /* Status color variants */
    .column[data-status="pending"] {
      background: #fff6f6; /* soft red */
      border-color: #ffd6d6;
    }
    .column[data-status="inprogress"] {
      background: #fffdf5; /* soft yellow */
      border-color: #fff1c6;
    }
    .column[data-status="completed"] {
      background: #f6fff7; /* soft green */
      border-color: #dff6e8;
    }

    /* Task accent bar per status */
    .column[data-status="pending"] .task { box-shadow: 0 1px 3px rgba(231,76,60,0.06); border-left: 6px solid #e74c3c; }
    .column[data-status="inprogress"] .task { box-shadow: 0 1px 3px rgba(241,196,15,0.06); border-left: 6px solid #f1c40f; }
    .column[data-status="completed"] .task { box-shadow: 0 1px 3px rgba(46,204,113,0.06); border-left: 6px solid #2ecc71; }

    /* Slightly darker title for contrast */
    .column[data-status="pending"] .task-title { color: #b03a2e; }
    .column[data-status="inprogress"] .task-title { color: #a07b0a; }
    .column[data-status="completed"] .task-title { color: #1e8449; }

    .column h4 { font-size: 16px; margin-bottom: 8px; display:flex; justify-content:space-between; align-items:center; }

    .task-list { display: flex; flex-direction: column; gap: 8px; }

    .task {
      background: white;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .task-title { flex: 1; color: #2f3640; }

    .task-meta { display:flex; gap:6px; align-items:center; }

    .task-btn {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d9e3ea;
      background: #f7fbfd;
      cursor: pointer;
      font-size: 13px;
    }

    .task-btn.small { padding: 6px 8px; font-size: 14px; }
    .task-btn.danger { background: #ffefef; border-color: #ffd6d6; color: #c0392b; }

    @media (max-width: 900px) {
      .columns { grid-template-columns: 1fr; }
    }

    /* Chart */
    .chart-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 20px;
    }

    canvas {
      width: 100% !important;
      height: 300px !important;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 200px;
        position: absolute;
        left: -200px;
        z-index: 100;
      }

      .sidebar.active {
        left: 0;
      }

      .toggle-btn {
        display: block;
      }

      .main {
        margin-left: 0;
      }
    }
    @media (max-width: 500px) {
      .topbar h1 {
        font-size: 18px;
      }
    }

  </style>
</head>
<body>
   <div class="sidebar">
    <h2>DASHBOARD</h2>
    <ul class="nav">
      <li><a href="index.html" class="active"><span class="nav-icon">🏠</span><span>Dashboard</span></a></li>
      <li><a href="hoa.html" class="active"><span class="nav-icon" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm6 1c-1.66 0-3 1.34-3 3v3h6v-3c0-1.66-1.34-3-3-3zM6 13c-1.66 0-3 1.34-3 3v3h6v-3c0-1.66-1.34-3-3-3z" fill="currentColor"/></svg></span><span>Homeowners</span></a></li>
       <li><a href="tracking.html" class="active"><span class="nav-icon" aria-hidden="true"><img src="tracking.png" alt="" height="20" width="20"></span><span>Tracking</span></a></li>
     </ul>
    <!-- Logout placed at bottom of sidebar for easier access on mobile/desktop -->
    <ul class="nav logout-nav" style="position:absolute;bottom:20px;left:20px;right:20px;padding:0;margin:0;">
      <li style="margin:0">
        <a href="#" id="logoutBtn" role="button" aria-haspopup="dialog"><span class="nav-icon">🚪</span><span>Logout</span></a>
      </li>
    </ul>
  </div>

  <script>
    // Sidebar homeowners submenu toggle
    (function(){
      const toggle = document.getElementById('homeownersToggle');
      if(!toggle) return;
      const li = toggle.closest('.has-submenu');
      const submenu = li.querySelector('.submenu');
      toggle.addEventListener('click', (e)=>{
        e.preventDefault();
        const open = submenu.style.display === 'block';
        submenu.style.display = open ? 'none' : 'block';
      });
    })();
  </script>

  <div class="main">
    <div class="topbar">
      <span class="toggle-btn" id="toggle-btn">☰</span>

      <div class="brand" style="display:flex;align-items:center;gap:12px">
        <img src="nha.png" alt="logo" height="44" width="44" style="border-radius:6px;display:block" />
        <div class="brand-text"><h1 style="font-size:18px;margin:0">CSSU NHA - LAGUNA DISTRICT OFFICE</h1></div>
      </div>

      <!-- centered page title -->
      <div style="position:absolute;left:50%;transform:translateX(-50%);top:50%;transform:translate(-50%,-50%);pointer-events:none">
        <div style="font-weight:700;color:#2f3640;letter-spacing:0.4px">DASHBOARD OVERVIEW</div>
      </div>

      <div id="userMenu" style="display:flex;align-items:center;gap:10px">
        <div id="userBadge" style="display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:10px;background:#fff;box-shadow:0 1px 2px rgba(16,24,40,0.04)">
          <div id="userAvatar" style="width:30px;height:30px;border-radius:50%;background:#6b46c1;color:#fff;display:flex;align-items:center;justify-content:center;font-size:14px;flex:0 0 30px">👤</div>
          <div id="userName" style="color:#374151;font-weight:600">Admin</div>
        </div>
      </div>
    </div>
    
    <!-- Announcements -->
    <div class="card announcements-card" id="announcementsCard">
      <h3>Announcements</h3>
      <div class="ann-controls">
        <input id="announcementInput" type="text" placeholder="Write announcement and press Add" />
        <button id="addAnnouncementBtn">Add</button>
      </div>
      <ul id="announcementList" class="announcement-list"></ul>
    </div>

    <!-- Recent History -->
    <div class="card" id="historyCard" style="margin-top:12px">
      <h3>Recent History</h3>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;justify-content:space-between;flex-wrap:wrap">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label style="font-size:13px;color:#444">From</label>
          <input id="historyFrom" type="date" style="padding:6px;border-radius:6px;border:1px solid #e6e9ee" />
          <label style="font-size:13px;color:#444">To</label>
          <input id="historyTo" type="date" style="padding:6px;border-radius:6px;border:1px solid #e6e9ee" />
          <label style="font-size:13px;color:#444">User</label>
          <select id="historyUserFilter" style="padding:6px;border-radius:6px;border:1px solid #e6e9ee"><option value="">All</option></select>
          <input id="historySearch" placeholder="Search messages" style="padding:6px;border-radius:6px;border:1px solid #e6e9ee;min-width:180px" />
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="historyExportPdfBtn" class="btn" style="background:#e74c3c;color:#fff">Export PDF</button>
          <button id="historyExportCsvBtn" class="btn" style="background:#2ecc71;color:#fff">Export Excel</button>
        </div>
      </div>
      <div style="max-height:220px;overflow:auto;border:1px solid #eef3f6;padding:8px;border-radius:6px;background:#fbfdff">
        <ul id="historyList" style="list-style:none;padding-left:0;margin:0;display:flex;flex-direction:column;gap:6px"></ul>
      </div>
    </div>

    <!-- Calendar Activities (real calendar) -->
    <div class="card" id="calendarCard" style="margin-top:12px">
      <h3>Calendar Activities</h3>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px;flex-wrap:wrap">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="calPrev" class="btn" style="padding:6px 10px">◀</button>
          <div id="calTitle" style="font-weight:600;min-width:180px;text-align:center"></div>
          <button id="calNext" class="btn" style="padding:6px 10px">▶</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <label style="font-size:13px;color:#444">View:</label>
          <select id="calView" style="padding:6px;border-radius:6px;border:1px solid #e6e9ee">
            <option value="month">Month</option>
          </select>
        </div>
      </div>

      <div id="calendarRoot" style="margin-bottom:12px">
        <div id="calendarGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px"></div>
      </div>

      <!-- Quick add / details -->
      <div class="calendar-controls" style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
        <input id="eventTitle" placeholder="Event title" style="padding:8px;border:1px solid #e6e9ee;border-radius:6px;min-width:180px" />
  <input id="eventDate" type="date" style="padding:8px;border:1px solid #e6e9ee;border-radius:6px" />
  <input id="eventEndDate" type="date" title="Optional end date for multi-day events" style="padding:8px;border:1px solid #e6e9ee;border-radius:6px" />
  <input id="eventTime" type="time" style="padding:8px;border:1px solid #e6e9ee;border-radius:6px" />
  <input id="eventLocation" placeholder="Location" style="padding:8px;border:1px solid #e6e9ee;border-radius:6px;min-width:140px" />
  <input id="eventColor" type="color" title="Event color" value="#e8f5e9" style="width:44px;height:36px;padding:2px;border-radius:6px;border:1px solid #e6e9ee" />
        <button id="addEventBtn" class="btn">Add</button>
        <button id="clearEventsBtn" class="btn" style="background:#95a5a6">Clear All</button>
      </div>

      <div style="display:flex;gap:12px">
        <div style="flex:1">
          <ul id="eventsList" class="announcement-list" style="max-height:240px;overflow:auto"></ul>
        </div>
        <div style="width:220px">
          <div style="font-size:13px;color:#444;margin-bottom:6px">Selected date</div>
          <div id="selectedDateDisplay" style="padding:8px;border-radius:6px;border:1px solid #eef3f6;background:#fbfdff;color:#333">None</div>
        </div>
      </div>
    </div>

    <!-- Announcement Edit Modal -->
    <div id="annEditModal" class="modal" aria-hidden="true">
      <div class="modal-backdrop" id="annModalBackdrop"></div>
      <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="annModalTitle">
        <h4 id="annModalTitle">Edit Announcement</h4>
        <input id="annModalInput" type="text" />
        <div class="modal-actions">
          <button id="annModalSave">Save</button>
          <button id="annModalCancel">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Edit Event Modal -->
    <div id="editEventModal" class="modal" aria-hidden="true">
      <div class="modal-backdrop" id="editEventBackdrop"></div>
      <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="editEventTitle">
        <h4 id="editEventTitle">Edit Event</h4>
        <label style="font-size:13px;color:#333;margin-bottom:6px">Title</label>
        <input id="editEventTitleInput" type="text" style="width:100%;padding:8px;border:1px solid #e6e9ee;border-radius:6px;margin-bottom:8px" />
        <label style="font-size:13px;color:#333;margin-bottom:6px">Date</label>
        <input id="editEventDateInput" type="date" style="width:100%;padding:8px;border:1px solid #e6e9ee;border-radius:6px;margin-bottom:8px" />
        <label style="font-size:13px;color:#333;margin-bottom:6px">End Date (optional)</label>
        <input id="editEventEndDateInput" type="date" style="width:100%;padding:8px;border:1px solid #e6e9ee;border-radius:6px;margin-bottom:8px" />
        <label style="font-size:13px;color:#333;margin-bottom:6px">Time</label>
        <input id="editEventTimeInput" type="time" style="width:100%;padding:8px;border:1px solid #e6e9ee;border-radius:6px;margin-bottom:8px" />
        <label style="font-size:13px;color:#333;margin-bottom:6px">Location</label>
        <input id="editEventLocationInput" type="text" style="width:100%;padding:8px;border:1px solid #e6e9ee;border-radius:6px;margin-bottom:12px" />
        <label style="font-size:13px;color:#333;margin-bottom:6px">Color</label>
        <input id="editEventColorInput" type="color" value="#e8f5e9" style="width:44px;height:36px;padding:2px;border-radius:6px;border:1px solid #e6e9ee;margin-bottom:12px" />
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="cancelEditEvent" class="btn" style="background:#bdc3c7">Cancel</button>
          <button id="saveEditEvent" class="btn" style="background:#2563EB">Save</button>
        </div>
      </div>
    </div>

    <!-- Announcement Delete Modal -->
    <div id="annDeleteModal" class="modal" aria-hidden="true">
      <div class="modal-backdrop" id="annDeleteBackdrop"></div>
      <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="annDeleteTitle">
        <h4 id="annDeleteTitle">Delete Announcement</h4>
        <p id="annDeleteMessage">Are you sure you want to delete this announcement?</p>
        <div class="modal-actions">
          <button id="annDeleteConfirm" style="background:#c0392b">Delete</button>
          <button id="annDeleteCancel">Cancel</button>
        </div>
      </div>
    </div>


    <!-- To-Do Board -->
    <div class="todo-board" aria-label="To-Do Board">
      <h3>To-Do-List</h3>
      <div class="todo-progress" aria-hidden="false">
        <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <div class="progress-fill" id="todoProgressFill" style="width:0%"></div>
        </div>
        <div class="progress-text" id="todoProgressText">0%</div>
      </div>

      <!-- Edit Modal -->
      <div id="editModal" class="modal" aria-hidden="true">
        <div class="modal-backdrop" id="modalBackdrop"></div>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
          <h4 id="modalTitle">Edit Task</h4>
          <input id="modalInput" type="text" />
          <div class="modal-actions">
            <button id="modalSave">Save</button>
            <button id="modalCancel">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Delete Confirmation Modal -->
      <div id="deleteModal" class="modal" aria-hidden="true">
        <div class="modal-backdrop" id="deleteBackdrop"></div>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="deleteTitle">
          <h4 id="deleteTitle">Delete Task</h4>
          <p id="deleteMessage">Are you sure you want to delete this task?</p>
          <div class="modal-actions">
            <button id="deleteConfirm" style="background:#c0392b">Delete</button>
            <button id="deleteCancel">Cancel</button>
          </div>
        </div>
      </div>

      <div class="todo-controls">
        <input id="newTaskInput" type="text" placeholder="Add a new task and press Enter or click Add" />
        <button id="addTaskBtn">Add</button>
        <button id="clearCompletedBtn" title="Clear all completed">Clear Completed</button>
        <button id="exportPdfBtn" title="Export tasks as PDF">Export PDF</button>
        <button id="exportExcelBtn" title="Export tasks as Excel (CSV)">Export Excel</button>
      </div>

      <div class="columns">
        <div class="column" data-status="pending">
          <h4>Pending <span id="count-pending">0</span></h4>
          <div class="task-list" id="pendingList"></div>
        </div>

        <div class="column" data-status="inprogress">
          <h4>In Progress <span id="count-inprogress">0</span></h4>
          <div class="task-list" id="inprogressList"></div>
        </div>

        <div class="column" data-status="completed">
          <h4>Completed <span id="count-completed">0</span></h4>
          <div class="task-list" id="completedList"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>File Manager</h3>
      <div class="upload-row" style="margin-top:8px">
        <input id="titleInput" type="text" placeholder="Title (optional)" />
        <select id="categoryInput" title="Category"></select>
        <input id="fileInput" type="file" />
        <button id="uploadBtn" class="btn">Upload</button>
      </div>
      <div style="margin-top:8px;color:#666;font-size:13px">Files are stored in your browser (IndexedDB). Choose a category or leave blank to auto-detect from filename.</div>
  </div>

    <div style="height:12px"></div>

    <div class="card" style="margin-top:12px">
      <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label style="font-size:13px;color:#444">From</label>
          <input id="fromDate" type="date" style="padding:6px;border-radius:6px;border:1px solid #e6e9ee" />
          <label style="font-size:13px;color:#444">To</label>
          <input id="toDate" type="date" style="padding:6px;border-radius:6px;border:1px solid #e6e9ee" />
          <label style="font-size:13px;color:#444">Category</label>
          <select id="categoryFilter" style="padding:6px;border-radius:6px;border:1px solid #e6e9ee">
            <option value="">All</option>
          </select>
          <button id="clearDates" class="btn" style="background:#95a5a6">Clear</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <label style="font-size:13px;color:#444">Per page</label>
          <select id="perPageSelect" style="padding:6px;border-radius:6px;border:1px solid #e6e9ee">
            <option>5</option>
            <option selected>10</option>
            <option>25</option>
            <option>50</option>
          </select>
        </div>
      </div>

      <div style="overflow:auto;margin-top:12px">
        <table id="filesTable" style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="background:#f1f5f9">
              <th style="text-align:left;padding:8px;border-bottom:1px solid #e6e9ee">Tracker</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #e6e9ee">Title</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #e6e9ee">Filename</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #e6e9ee">Category</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #e6e9ee">Upload at</th>
              <th style="text-align:center;padding:8px;border-bottom:1px solid #e6e9ee">Actions</th>
            </tr>
          </thead>
          <tbody id="filesTbody"></tbody>
        </table>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div style="font-size:13px;color:#555">Total: <span id="totalCount">0</span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="prevPage" class="btn" style="background:#95a5a6">Prev</button>
          <div id="paginationInfo" style="font-size:13px;color:#444">Page 1 / 1</div>
          <button id="nextPage" class="btn">Next</button>
        </div>
      </div>
    </div>
  </div>

  

  <div id="viewModal" class="modal" role="dialog" aria-modal="true">
    <div class="card">
      <div id="viewContent"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <a id="downloadLink" class="btn" href="#" download>Download</a>
        <button id="closeViewBtn" class="btn" style="background:#bdc3c7">Close</button>
      </div>
    </div>
  </div>

  <!-- Logout confirmation modal -->
  <div id="logoutModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" id="logoutBackdrop"></div>
    <div class="modal-content" role="dialog" aria-modal="true">
      <h4>Logout</h4>
      <p>Are you sure you want to logout of your account?</p>
      <div class="modal-actions" style="margin-top:12px">
        <button id="logoutCancel" class="primary">Cancel</button>
        <button id="logoutConfirm" class="danger">Logout</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal" role="dialog" aria-modal="true">
    <div class="card">
      <h3>Edit File</h3>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
        <label>Title</label>
        <input id="editTitle" type="text" style="padding:8px;border:1px solid #e6e9ee;border-radius:6px" />
        <label>Category</label>
        <select id="editCategory" style="padding:8px;border:1px solid #e6e9ee;border-radius:6px"></select>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:6px">
          <button id="cancelEdit" class="btn" style="background:#bdc3c7">Cancel</button>
          <button id="saveEdit" class="btn">Save</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    const CATEGORIES = ['EHAP','EPHAP','888','FOI','CBTAP','CONDONATION','GAD','COHSEP'];
    const DB_NAME = 'rdtfDB';
    const STORE_NAME = 'files';
    let db;

    function openDB(){
      return new Promise((resolve,reject)=>{
        const req = indexedDB.open(DB_NAME,1);
        req.onupgradeneeded = (e)=>{ const idb = e.target.result; if(!idb.objectStoreNames.contains(STORE_NAME)) idb.createObjectStore(STORE_NAME,{ keyPath:'tracker', autoIncrement:true }); };
        req.onsuccess = ()=>{ db = req.result; resolve(db); };
        req.onerror = ()=> reject(req.error);
      });
    }

    function addFileRecord(rec){ return new Promise((resolve,reject)=>{ const tx = db.transaction(STORE_NAME,'readwrite'); const store = tx.objectStore(STORE_NAME); const req = store.add(rec); req.onsuccess = e=> resolve(e.target.result); req.onerror = ()=> reject(req.error); }); }
    function getAllFiles(){ return new Promise((resolve,reject)=>{ const tx = db.transaction(STORE_NAME,'readonly'); const store = tx.objectStore(STORE_NAME); const req = store.getAll(); req.onsuccess = ()=> resolve(req.result); req.onerror = ()=> reject(req.error); }); }
    function getFile(id){ return new Promise((resolve,reject)=>{ const tx = db.transaction(STORE_NAME,'readonly'); const store = tx.objectStore(STORE_NAME); const req = store.get(Number(id)); req.onsuccess = ()=> resolve(req.result); req.onerror = ()=> reject(req.error); }); }
    function updateRecord(rec){ return new Promise((resolve,reject)=>{ const tx = db.transaction(STORE_NAME,'readwrite'); const store = tx.objectStore(STORE_NAME); const req = store.put(rec); req.onsuccess = ()=> resolve(req.result); req.onerror = ()=> reject(req.error); }); }
    function deleteRecord(id){ return new Promise((resolve,reject)=>{ const tx = db.transaction(STORE_NAME,'readwrite'); const store = tx.objectStore(STORE_NAME); const req = store.delete(Number(id)); req.onsuccess = ()=> resolve(); req.onerror = ()=> reject(req.error); }); }

  const categoryInput = document.getElementById('categoryInput');
  const titleInput = document.getElementById('titleInput');
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const viewModalEl = document.getElementById('viewModal');
  const viewContent = document.getElementById('viewContent');
  const downloadLink = document.getElementById('downloadLink');
  const closeViewBtn = document.getElementById('closeViewBtn');
  const fromDate = document.getElementById('fromDate');
  const toDate = document.getElementById('toDate');
  const categoryFilter = document.getElementById('categoryFilter');
  const clearDates = document.getElementById('clearDates');
  const perPageSelect = document.getElementById('perPageSelect');
  const filesTbody = document.getElementById('filesTbody');
  const totalCountEl = document.getElementById('totalCount');
  const prevPage = document.getElementById('prevPage');
  const nextPage = document.getElementById('nextPage');
  const paginationInfo = document.getElementById('paginationInfo');
  
  const editTitle = document.getElementById('editTitle');
  const editCategory = document.getElementById('editCategory');
  const cancelEdit = document.getElementById('cancelEdit');
  const saveEdit = document.getElementById('saveEdit');

  function populateCategories(){ categoryInput.innerHTML = '<option value="">(detect)</option>' + CATEGORIES.map(c=>`<option value="${c}">${c}</option>`).join(''); editCategory.innerHTML = '<option value="">(detect)</option>' + CATEGORIES.map(c=>`<option value="${c}">${c}</option>`).join(''); }
      // also populate top category filter
      function populateCategoryFilter(){
        if(!categoryFilter) return;
        categoryFilter.innerHTML = '<option value="">All</option>' + CATEGORIES.map(c=>`<option value="${c}">${c}</option>`).join('');
      }
    function detectCategory(name){ if(!name) return ''; const lower = name.toLowerCase(); for(const c of CATEGORIES) if(lower.includes(c.toLowerCase())) return c; return ''; }
    function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }
    function bytesToSize(bytes){ if(!bytes) return '0 B'; const k=1024; const sizes=['B','KB','MB','GB']; const i=Math.floor(Math.log(bytes)/Math.log(k)); return parseFloat((bytes/Math.pow(k,i)).toFixed(2)) + ' ' + sizes[i]; }
    function colorClassFor(cat){ return 'c-' + (cat||'').toUpperCase().replace(/\s+/g,'').replace(/[^A-Z0-9]/g,''); }

    // Table rendering with filter + pagination
    let state = { all: [], filtered: [], page: 1, perPage: Number(perPageSelect.value) || 10 };

    function applyFilters(){
      const from = fromDate.value ? new Date(fromDate.value).setHours(0,0,0,0) : null;
      const to = toDate.value ? new Date(toDate.value).setHours(23,59,59,999) : null;
      const cat = categoryFilter && categoryFilter.value ? categoryFilter.value : '';
      state.filtered = state.all.filter(rec=>{
        if(from && rec.createdAt < from) return false;
        if(to && rec.createdAt > to) return false;
        const recCat = rec.category || detectCategory(rec.name) || '';
        if(cat && recCat !== cat) return false;
        return true;
      }).sort((a,b)=> (Number(a.tracker) || 0) - (Number(b.tracker) || 0) );
      state.page = 1; // reset to first page when filters change
    }

    function renderTable(){
      const total = state.filtered.length;
      totalCountEl.textContent = total;
      const per = state.perPage;
      const pages = Math.max(1, Math.ceil(total / per));
      if(state.page > pages) state.page = pages;
      const start = (state.page - 1) * per;
      const pageItems = state.filtered.slice(start, start + per);

      filesTbody.innerHTML = '';
      for(const rec of pageItems){
        const tr = document.createElement('tr');
        const trackerTd = document.createElement('td'); trackerTd.style.padding='8px'; trackerTd.textContent = rec.tracker || '';
        tr.appendChild(trackerTd);
        const titleTd = document.createElement('td'); titleTd.style.padding='8px'; titleTd.textContent = rec.title || rec.name; tr.appendChild(titleTd);
        const nameTd = document.createElement('td'); nameTd.style.padding='8px'; nameTd.textContent = rec.name; tr.appendChild(nameTd);
        const catTd = document.createElement('td'); catTd.style.padding='8px'; catTd.textContent = rec.category || detectCategory(rec.name) || 'Uncategorized'; tr.appendChild(catTd);
  // size column removed per request
        const createdTd = document.createElement('td'); createdTd.style.padding='8px'; createdTd.textContent = new Date(rec.createdAt).toLocaleString(); tr.appendChild(createdTd);
        const actionsTd = document.createElement('td'); actionsTd.style.padding='8px'; actionsTd.style.textAlign='center';
        const viewBtn = document.createElement('button'); viewBtn.className='btn'; viewBtn.style.padding='6px 8px'; viewBtn.textContent='View'; viewBtn.addEventListener('click', ()=>openView(rec.tracker)); actionsTd.appendChild(viewBtn);
  // update button removed per request
        const delBtn = document.createElement('button'); delBtn.className='btn danger'; delBtn.style.marginLeft='6px'; delBtn.style.background='var(--danger)'; delBtn.textContent='Delete'; delBtn.addEventListener('click', ()=>confirmDelete(rec.tracker)); actionsTd.appendChild(delBtn);
        tr.appendChild(actionsTd);
        filesTbody.appendChild(tr);
      }

      paginationInfo.textContent = `Page ${state.page} / ${pages}`;
      prevPage.disabled = state.page <= 1; nextPage.disabled = state.page >= pages;
    }

    async function refreshAndRender(){
      state.all = await getAllFiles() || [];
      applyFilters();
      renderTable();
    }

    uploadBtn.addEventListener('click', async ()=>{
      const f = fileInput.files && fileInput.files[0]; if(!f){ alert('Choose a file'); return; }
      const title = titleInput.value.trim() || f.name;
      let category = categoryInput.value || '';
      if(!category) category = detectCategory(f.name) || '';
      const rec = { name:f.name, type:f.type, size:f.size, title, category, data: f, createdAt: Date.now(), updatedAt: Date.now() };
      await addFileRecord(rec);
      titleInput.value=''; fileInput.value=''; categoryInput.value='';
      await refreshAndRender();
      if(window.logHistory) window.logHistory(`File uploaded: ${rec.name} (${rec.category||'Uncategorized'})`);
    });

    async function openView(id){ const rec = await getFile(id); if(!rec) return alert('Not found'); viewContent.innerHTML=''; const header = document.createElement('div'); header.innerHTML = `<strong>${escapeHtml(rec.title)}</strong><div style="color:#666">${escapeHtml(rec.name)}</div>`; viewContent.appendChild(header); const blob = rec.data instanceof Blob ? rec.data : new Blob([rec.data],{type:rec.type}); const url = URL.createObjectURL(blob); downloadLink.href = url; downloadLink.download = rec.name || 'file'; if(rec.type && rec.type.startsWith('image/')){ const img = document.createElement('img'); img.src=url; img.style.maxWidth='100%'; img.style.borderRadius='6px'; viewContent.appendChild(img); } else if((rec.type && rec.type.startsWith('text/')) || rec.name.match(/\.txt$|\.md$|\.csv$|\.json$/i)){ const fr = new FileReader(); fr.onload = ()=>{ const pre = document.createElement('pre'); pre.textContent = fr.result; viewContent.appendChild(pre); }; fr.readAsText(blob); }
      viewModalEl.setAttribute('open',''); if(window.logHistory) window.logHistory(`File viewed: ${rec.name}`);
    }

  // Open Edit Modal
  let editingId = null;
  function openEditModal(id){ editingId = id; getFile(id).then(rec=>{ editTitle.value = rec.title || rec.name; editCategory.value = rec.category || ''; editModal.setAttribute('open',''); }); }

  cancelEdit.addEventListener('click', ()=>{ editModal.removeAttribute('open'); editingId = null; });
  saveEdit.addEventListener('click', async ()=>{ if(!editingId) return; const rec = await getFile(editingId); const oldTitle = rec.title || rec.name; rec.title = editTitle.value.trim()||rec.name; rec.category = editCategory.value||rec.category; rec.updatedAt = Date.now(); await updateRecord(rec); editModal.removeAttribute('open'); editingId = null; await refreshAndRender(); if(window.logHistory) window.logHistory(`File edited: ${oldTitle} → ${rec.title}`); });

  // openUpdate removed per request

  async function confirmDelete(id){ if(!confirm('Delete this file?')) return; const rec = await getFile(id); await deleteRecord(id); await refreshAndRender(); if(window.logHistory) window.logHistory(`File deleted: ${rec?rec.name:id}`); }

  // Pagination & filters
  fromDate.addEventListener('change', ()=>{ applyFilters(); renderTable(); });
  toDate.addEventListener('change', ()=>{ applyFilters(); renderTable(); });
  categoryFilter && categoryFilter.addEventListener('change', ()=>{ applyFilters(); renderTable(); });
  clearDates.addEventListener('click', ()=>{ fromDate.value=''; toDate.value=''; applyFilters(); renderTable(); });
  perPageSelect.addEventListener('change', ()=>{ state.perPage = Number(perPageSelect.value); state.page = 1; renderTable(); });
  prevPage.addEventListener('click', ()=>{ if(state.page>1){ state.page--; renderTable(); } });
  nextPage.addEventListener('click', ()=>{ const pages = Math.max(1, Math.ceil(state.filtered.length/state.perPage)); if(state.page<pages){ state.page++; renderTable(); } });

  closeViewBtn.addEventListener('click', ()=> viewModalEl.removeAttribute('open'));

  (async function(){ await openDB(); populateCategories(); populateCategoryFilter(); await refreshAndRender(); })();
  </script>

  <!-- Fallback: ensure Edit Task modal Cancel/backdrop always close the modal -->
  <script>
    (function(){
      try{
        const modalEl = document.getElementById('editModal');
        const cancelBtn = document.getElementById('modalCancel');
        const backdrop = document.getElementById('modalBackdrop');
        function hide(){ if(modalEl) modalEl.setAttribute('aria-hidden','true'); }
        if(cancelBtn) cancelBtn.addEventListener('click', hide);
        if(backdrop) backdrop.addEventListener('click', hide);
        // also support Escape key as a fallback
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hide(); });
      }catch(err){ console.warn('modal fallback init failed', err); }
    })();
  </script>

   

  <script>
   

    /* ----------------------------
       To-Do List Functionality
       ---------------------------- */
    (function(){
      const STORAGE_KEY = 'todoTasks_v1';
      let tasks = [];

      // Elements
      const newTaskInput = document.getElementById('newTaskInput');
      const addTaskBtn = document.getElementById('addTaskBtn');
      const pendingList = document.getElementById('pendingList');
      const inprogressList = document.getElementById('inprogressList');
      const completedList = document.getElementById('completedList');
      const counts = {
        pending: document.getElementById('count-pending'),
        inprogress: document.getElementById('count-inprogress'),
        completed: document.getElementById('count-completed')
      };

      function save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
      }

      function load() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          tasks = raw ? JSON.parse(raw) : [];
        } catch (e) {
          tasks = [];
          console.error('Failed to load tasks', e);
        }
      }

      function uid() {
        return Date.now().toString(36) + Math.random().toString(36).slice(2,8);
      }

      function addTask(title) {
        if (!title || !title.trim()) return;
        const task = {
          id: uid(),
          title: title.trim(),
          status: 'pending',
          createdAt: Date.now()
        };
        tasks.push(task);
        save();
        render();
        if(window.logHistory) window.logHistory(`Task added: ${task.title}`);
      }

      function deleteTask(id) {
        const t = tasks.find(t=>t.id===id);
        tasks = tasks.filter(t => t.id !== id);
        save();
        render();
        if(window.logHistory) window.logHistory(`Task deleted: ${t? t.title : id}`);
      }

      // Modal edit state
      let editingId = null;

      function openEditModal(id) {
        const modal = document.getElementById('editModal');
        const input = document.getElementById('modalInput');
        const task = tasks.find(t => t.id === id);
        if (!task) return;
        editingId = id;
        input.value = task.title;
        modal.setAttribute('aria-hidden', 'false');
        input.focus();
        input.select();
      }

      function closeEditModal() {
        const modal = document.getElementById('editModal');
        modal.setAttribute('aria-hidden', 'true');
        editingId = null;
      }

      function saveModalEdit() {
        const input = document.getElementById('modalInput');
        if (!editingId) return closeEditModal();
        const task = tasks.find(t => t.id === editingId);
        if (!task) return closeEditModal();
        const val = input.value.trim();
        if (val) task.title = val;
        save();
        render();
        closeEditModal();
      }

      // replace old editTask to open modal
      function editTask(id) {
        openEditModal(id);
      }

      // Delete modal state
      let deletingId = null;

      function openDeleteModal(id, title) {
        deletingId = id;
        const modal = document.getElementById('deleteModal');
        const msg = document.getElementById('deleteMessage');
        msg.textContent = `Delete "${title}"? This action cannot be undone.`;
        modal.setAttribute('aria-hidden', 'false');
      }

      function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.setAttribute('aria-hidden', 'true');
        deletingId = null;
      }

      function confirmDelete() {
        if (!deletingId) return closeDeleteModal();
        deleteTask(deletingId);
        closeDeleteModal();
      }

      function moveTask(id, toStatus) {
        const task = tasks.find(t => t.id === id);
        if (!task) return;
        task.status = toStatus;
        save();
        render();
        if(window.logHistory) window.logHistory(`Task moved: ${task.title} → ${toStatus}`);
      }

      function createTaskNode(task) {
        const el = document.createElement('div');
        el.className = 'task';
        el.setAttribute('data-id', task.id);

        const title = document.createElement('div');
        title.className = 'task-title';
        title.textContent = task.title;
        el.appendChild(title);

        const meta = document.createElement('div');
        meta.className = 'task-meta';

        // (Arrows and Edit button removed per request)

        const delBtn = document.createElement('button');
        delBtn.className = 'task-btn danger';
        delBtn.title = 'Delete';
        delBtn.textContent = 'Delete';
        delBtn.addEventListener('click', () => openDeleteModal(task.id, task.title));
        meta.appendChild(delBtn);

        el.appendChild(meta);
        return el;
      }

      function render() {
        // clear
        pendingList.innerHTML = '';
        inprogressList.innerHTML = '';
        completedList.innerHTML = '';

        const byStatus = {
          pending: tasks.filter(t => t.status === 'pending'),
          inprogress: tasks.filter(t => t.status === 'inprogress'),
          completed: tasks.filter(t => t.status === 'completed')
        };

        byStatus.pending.forEach(t => pendingList.appendChild(createTaskNode(t)));
        byStatus.inprogress.forEach(t => inprogressList.appendChild(createTaskNode(t)));
        byStatus.completed.forEach(t => completedList.appendChild(createTaskNode(t)));

        counts.pending.textContent = byStatus.pending.length;
        counts.inprogress.textContent = byStatus.inprogress.length;
        counts.completed.textContent = byStatus.completed.length;

        // update overall progress
        const total = tasks.length;
        const completedCount = byStatus.completed.length;
        const percent = total === 0 ? 0 : Math.round((completedCount / total) * 100);
        const fill = document.getElementById('todoProgressFill');
        const text = document.getElementById('todoProgressText');
        if (fill) fill.style.width = percent + '%';
        if (text) text.textContent = percent + '%';
      }

      function allowDrop(ev) {
        ev.preventDefault();
      }

      function onDragStart(ev) {
        ev.dataTransfer.setData('text/plain', ev.target.getAttribute('data-id'));
        ev.dataTransfer.effectAllowed = 'move';
      }

      function wireDnD() {
        // delegate drag events on task elements after render
        [pendingList, inprogressList, completedList].forEach(list => {
          const column = list.closest('.column');
          column.addEventListener('dragover', allowDrop);
          column.addEventListener('drop', (ev) => {
            ev.preventDefault();
            const id = ev.dataTransfer.getData('text/plain');
            const toStatus = column.getAttribute('data-status');
            moveTask(id, toStatus);
          });
        });
      }

      function makeInlineEditable(node, task) {
        const titleEl = node.querySelector('.task-title');
        titleEl.setAttribute('tabindex', '0');
        titleEl.addEventListener('dblclick', () => {
          const input = document.createElement('input');
          input.type = 'text';
          input.value = task.title;
          input.className = 'inline-edit';
          node.replaceChild(input, titleEl);
          input.focus();
          input.select();
          input.addEventListener('blur', () => {
            task.title = input.value.trim() || task.title;
            save();
            render();
          });
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              input.blur();
            } else if (e.key === 'Escape') {
              render();
            }
          });
        });
      }

      function enhanceTaskNode(el, task) {
        // set draggable
        el.setAttribute('draggable', 'true');
        el.addEventListener('dragstart', onDragStart);
        // inline edit
        makeInlineEditable(el, task);
      }

      // override createTaskNode to call enhanceTaskNode before returning
      const _createTaskNode = createTaskNode;
      createTaskNode = function(task) {
        const node = _createTaskNode(task);
        enhanceTaskNode(node, task);
        return node;
      };

      // export tasks as printable PDF via print dialog
      function exportTasksPDF() {
        const rows = tasks.slice().map(t => `<tr><td>${escapeHtml(t.id)}</td><td>${escapeHtml(t.title)}</td><td>${escapeHtml(t.status)}</td><td>${new Date(t.createdAt).toLocaleString()}</td></tr>`).join('');
        const win = window.open('', '_blank');
        const html = `<html><head><title>Tasks Export</title><style>body{font-family:Arial,Helvetica,sans-serif;padding:20px}table{width:100%;border-collapse:collapse}th,td{padding:8px;border:1px solid #ddd}</style></head><body><h2>Tasks</h2><table><thead><tr><th>ID</th><th>Title</th><th>Status</th><th>Created</th></tr></thead><tbody>${rows}</tbody></table></body></html>`;
        win.document.write(html); win.document.close(); win.focus(); setTimeout(()=>win.print(), 300);
      }

      // export tasks as CSV (Excel-friendly)
      function exportTasksCSV() {
        const cols = ['id','title','status','createdAt'];
        const csv = [cols.join(',')].concat(tasks.map(r => cols.map(c => '"' + (String(r[c]||'')).replace(/"/g,'""') + '"').join(','))).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `tasks_export.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      function clearCompleted() {
        if (!confirm('Clear all completed tasks?')) return;
        tasks = tasks.filter(t => t.status !== 'completed');
        save();
        render();
        if(window.logHistory) window.logHistory('Cleared all completed tasks');
      }

      function init() {
        load();
        render();
        wireDnD();

        addTaskBtn.addEventListener('click', () => {
          addTask(newTaskInput.value);
          newTaskInput.value = '';
          newTaskInput.focus();
        });

        newTaskInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            addTask(newTaskInput.value);
            newTaskInput.value = '';
          }
        });

        // wire export and clear controls
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const clearCompletedBtn = document.getElementById('clearCompletedBtn');
        if(exportPdfBtn) exportPdfBtn.addEventListener('click', exportTasksPDF);
        if(exportExcelBtn) exportExcelBtn.addEventListener('click', exportTasksCSV);
        if(clearCompletedBtn) clearCompletedBtn.addEventListener('click', clearCompleted);

        // delete modal wiring
        const deleteModal = document.getElementById('deleteModal');
        const deleteConfirm = document.getElementById('deleteConfirm');
        const deleteCancel = document.getElementById('deleteCancel');
        const deleteBackdrop = document.getElementById('deleteBackdrop');

        deleteConfirm.addEventListener('click', confirmDelete);
        deleteCancel.addEventListener('click', closeDeleteModal);
        deleteBackdrop.addEventListener('click', closeDeleteModal);

        // modal controls
        const modal = document.getElementById('editModal');
        const modalSave = document.getElementById('modalSave');
        const modalCancel = document.getElementById('modalCancel');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const modalInput = document.getElementById('modalInput');

        modalSave.addEventListener('click', saveModalEdit);
        modalCancel.addEventListener('click', closeEditModal);
        modalBackdrop.addEventListener('click', closeEditModal);
        modalInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') saveModalEdit();
          else if (e.key === 'Escape') closeEditModal();
        });

        // accessibility: allow double-click to edit (kept for safety)
        [pendingList, inprogressList, completedList].forEach(list => {
          list.addEventListener('dblclick', (e) => {
            const node = e.target.closest('.task');
            if (!node) return;
            const id = node.getAttribute('data-id');
            editTask(id);
          });
        });
      }

      // initialize
      init();
    })();
  
    /* Announcements module */
    (function(){
      const KEY = 'dashboardAnnouncements_v1';
      let anns = [];
      const listEl = document.getElementById('announcementList');
      const input = document.getElementById('announcementInput');
      const addBtn = document.getElementById('addAnnouncementBtn');

      function save() { localStorage.setItem(KEY, JSON.stringify(anns)); }
      function load() { try { anns = JSON.parse(localStorage.getItem(KEY)) || []; } catch(e){ anns = []; } }

      let editingIndex = null;
      let deletingIndex = null;

      function openAnnEditModal(idx) {
        editingIndex = idx;
        const modal = document.getElementById('annEditModal');
        const input = document.getElementById('annModalInput');
        input.value = anns[idx];
        modal.setAttribute('aria-hidden', 'false');
        input.focus();
        input.select();
      }

      function closeAnnEditModal() {
        const modal = document.getElementById('annEditModal');
        modal.setAttribute('aria-hidden', 'true');
        editingIndex = null;
      }

      function saveAnnEdit() {
        const input = document.getElementById('annModalInput');
        if (editingIndex === null) return closeAnnEditModal();
        const val = input.value.trim();
        if (val) { const old = anns[editingIndex]; anns[editingIndex] = val; if(window.logHistory) window.logHistory(`Announcement edited: ${old} → ${val}`); }
        save(); render(); closeAnnEditModal();
      }

      function openAnnDeleteModal(idx) {
        deletingIndex = idx;
        const modal = document.getElementById('annDeleteModal');
        const msg = document.getElementById('annDeleteMessage');
        msg.textContent = `Delete announcement: "${anns[idx]}"?`;
        modal.setAttribute('aria-hidden', 'false');
      }

      function closeAnnDeleteModal() {
        const modal = document.getElementById('annDeleteModal');
        modal.setAttribute('aria-hidden', 'true');
        deletingIndex = null;
      }

      function confirmAnnDelete() {
        if (deletingIndex === null) return closeAnnDeleteModal();
        const old = anns[deletingIndex]; anns.splice(deletingIndex,1);
        save(); render(); closeAnnDeleteModal(); if(window.logHistory) window.logHistory(`Announcement deleted: ${old}`);
      }

      function render() {
        listEl.innerHTML = '';
        anns.forEach((a, idx) => {
          const li = document.createElement('li');
          const text = document.createElement('div'); text.textContent = a;
          const actions = document.createElement('div'); actions.className='announcement-actions';
          const edit = document.createElement('button'); edit.textContent='Edit'; edit.className='edit'; edit.addEventListener('click', () => openAnnEditModal(idx));
          const del = document.createElement('button'); del.textContent='Delete'; del.className='del'; del.addEventListener('click', () => openAnnDeleteModal(idx));
          actions.appendChild(edit); actions.appendChild(del);
          li.appendChild(text); li.appendChild(actions);
          listEl.appendChild(li);
        });
      }

      addBtn.addEventListener('click', () => {
        const v = input.value.trim(); if (!v) return; anns.unshift(v); input.value=''; save(); render(); if(window.logHistory) window.logHistory(`Announcement added: ${v}`);
      });
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') addBtn.click(); });

  load(); render();

  // wire announcement modals
  const annModal = document.getElementById('annEditModal');
  const annModalSave = document.getElementById('annModalSave');
  const annModalCancel = document.getElementById('annModalCancel');
  const annModalBackdrop = document.getElementById('annModalBackdrop');
  const annModalInput = document.getElementById('annModalInput');

  const annDeleteModal = document.getElementById('annDeleteModal');
  const annDeleteConfirm = document.getElementById('annDeleteConfirm');
  const annDeleteCancel = document.getElementById('annDeleteCancel');
  const annDeleteBackdrop = document.getElementById('annDeleteBackdrop');

  annModalSave.addEventListener('click', saveAnnEdit);
  annModalCancel.addEventListener('click', closeAnnEditModal);
  annModalBackdrop.addEventListener('click', closeAnnEditModal);
  annModalInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') saveAnnEdit(); else if (e.key === 'Escape') closeAnnEditModal(); });

  annDeleteConfirm.addEventListener('click', confirmAnnDelete);
  annDeleteCancel.addEventListener('click', closeAnnDeleteModal);
  annDeleteBackdrop.addEventListener('click', closeAnnDeleteModal);
    })();
  
  /* ----------------------------
     Recent History Module
     ---------------------------- */
  (function(){
    const KEY = 'recentHistory_v1';
    const MAX = 200; // keep latest 200 entries
    let items = [];
    const listEl = document.getElementById('historyList');
    const countEl = document.getElementById('historyCount');
    const clearBtn = document.getElementById('clearHistoryBtn');


  function load(){ try{ items = JSON.parse(localStorage.getItem(KEY)) || []; }catch(e){ items = []; } }
  function save(){ try{ localStorage.setItem(KEY, JSON.stringify(items.slice(0,MAX))); }catch(e){ /* ignore */ } }

  // read logged user (same logic used elsewhere)
  function currentUser(){ try{ const s = sessionStorage.getItem('cssu_logged_user'); if(s) return JSON.parse(s); const l = localStorage.getItem('cssu_logged_user'); if(l) return JSON.parse(l); }catch(e){} return null; }

  function populateUserFilter(){
    const sel = document.getElementById('historyUserFilter'); if(!sel) return;
    const users = Array.from(new Set(items.map(i=>i.user).filter(Boolean))).sort();
    sel.innerHTML = '<option value="">All</option>' + users.map(u=>`<option value="${escapeHtml(u)}">${escapeHtml(u)}</option>`).join('');
  }

  function render(){ if(!listEl) return; listEl.innerHTML = ''; const selUser = (document.getElementById('historyUserFilter')||{}).value || ''; const search = (document.getElementById('historySearch')||{}).value || '';
    filteredEntries().slice().reverse().forEach(it=>{ if(selUser && it.user !== selUser) return; if(search && !it.msg.toLowerCase().includes(search.toLowerCase())) return; const li = document.createElement('li'); li.style.fontSize='13px'; li.style.color='#222'; li.style.padding='6px'; li.style.borderRadius='6px'; li.style.background='#fff'; li.style.border='1px solid #eef3f6'; const who = it.user ? `<strong style="color:#2f3640">${escapeHtml(it.user)}</strong> • ` : ''; li.innerHTML = `<div style="font-size:12px;color:#666;margin-bottom:4px">${new Date(it.ts).toLocaleString()}</div><div>${who}${escapeHtml(it.msg)}</div>`; listEl.appendChild(li); }); if(countEl) countEl.textContent = items.length; }

  window.logHistory = function(msg){ try{ const u = currentUser(); const userName = u ? (u.name || u.username || u.user || '') : ''; items.push({ ts: Date.now(), msg: String(msg), user: userName }); if(items.length>MAX) items = items.slice(items.length-MAX); save(); render(); }catch(e){ console.warn('logHistory failed', e); } };

  // helper to get entries within date range (inclusive)
  function filteredEntries(){
    const fromEl = document.getElementById('historyFrom');
    const toEl = document.getElementById('historyTo');
    const from = fromEl && fromEl.value ? new Date(fromEl.value).setHours(0,0,0,0) : null;
    const to = toEl && toEl.value ? new Date(toEl.value).setHours(23,59,59,999) : null;
    return items.filter(it=>{
      if(from && it.ts < from) return false;
      if(to && it.ts > to) return false;
      return true;
    }).slice().sort((a,b)=> a.ts - b.ts);
  }

  function exportHistoryCSV(){
    const rows = filteredEntries().filter(r=>{
      const selUser = (document.getElementById('historyUserFilter')||{}).value || '';
      const search = (document.getElementById('historySearch')||{}).value || '';
      if(selUser && r.user !== selUser) return false;
      if(search && !r.msg.toLowerCase().includes(search.toLowerCase())) return false;
      return true;
    });
    const cols = ['timestamp','user','message'];
    const csv = [cols.join(',')].concat(rows.map(r=> cols.map(c=> '"'+ String(c==='timestamp'? new Date(r.ts).toLocaleString() : (r[c]||'')).replace(/"/g,'""') + '"').join(','))).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `recent_history.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function exportHistoryPDF(){
    const rows = filteredEntries().filter(r=>{
      const selUser = (document.getElementById('historyUserFilter')||{}).value || '';
      const search = (document.getElementById('historySearch')||{}).value || '';
      if(selUser && r.user !== selUser) return false;
      if(search && !r.msg.toLowerCase().includes(search.toLowerCase())) return false;
      return true;
    });
    const rowsHtml = rows.map(r=> `<tr><td style="padding:6px;border:1px solid #ddd">${new Date(r.ts).toLocaleString()}</td><td style="padding:6px;border:1px solid #ddd">${escapeHtml(r.user||'')}</td><td style="padding:6px;border:1px solid #ddd">${escapeHtml(r.msg)}</td></tr>`).join('');
    const win = window.open('', '_blank');
    const html = `<html><head><title>Recent History</title><style>body{font-family:Arial,Helvetica,sans-serif;padding:20px}table{width:100%;border-collapse:collapse}th,td{padding:8px;border:1px solid #ddd}</style></head><body><h2>Recent History</h2><table><thead><tr><th>Timestamp</th><th>User</th><th>Message</th></tr></thead><tbody>${rowsHtml}</tbody></table></body></html>`;
    win.document.write(html); win.document.close(); win.focus(); setTimeout(()=>win.print(), 300);
  }

  // wire export controls if present
  const exportPdfBtn = document.getElementById('historyExportPdfBtn');
  const exportCsvBtn = document.getElementById('historyExportCsvBtn');
  if(exportPdfBtn) exportPdfBtn.addEventListener('click', exportHistoryPDF);
  if(exportCsvBtn) exportCsvBtn.addEventListener('click', exportHistoryCSV);

  // wire filter controls
  const fromEl = document.getElementById('historyFrom');
  const toEl = document.getElementById('historyTo');
  const userEl = document.getElementById('historyUserFilter');
  const searchEl = document.getElementById('historySearch');
  [fromEl,toEl,userEl,searchEl].forEach(el=>{ if(!el) return; el.addEventListener('change', render); el.addEventListener('input', render); });

  // initial
  load(); populateUserFilter(); render();
  })();
  </script>
  <script>
    // Calendar Activities - month grid calendar
    (function(){
      const KEY = 'calendarActivities_v1';
      const calGrid = document.getElementById('calendarGrid');
      const calTitle = document.getElementById('calTitle');
      const calPrev = document.getElementById('calPrev');
      const calNext = document.getElementById('calNext');
      const eventsList = document.getElementById('eventsList');
      const selectedDateDisplay = document.getElementById('selectedDateDisplay');

  const titleEl = document.getElementById('eventTitle');
  const dateEl = document.getElementById('eventDate');
  const endDateEl = document.getElementById('eventEndDate');
  const timeEl = document.getElementById('eventTime');
  const locEl = document.getElementById('eventLocation');
  const colorEl = document.getElementById('eventColor');
      const addBtn = document.getElementById('addEventBtn');
      const clearBtn = document.getElementById('clearEventsBtn');

      // Palette for automatic event colors. New events will cycle through these
      // when the color picker is left at its default value so multiple activities
      // on the same day get visually distinct colors.
      const EVENT_PALETTE = [
        '#e8f5e9', // soft green
        '#e6f7ff', // soft blue
        '#fff7e6', // soft orange
        '#fff0f6', // soft pink
        '#f3f9e6', // soft lime
        '#e9eafc'  // soft lavender
      ];

      function getNextColorForDate(dateIso){
        try{
          const evs = eventsForDay(dateIso) || [];
          return EVENT_PALETTE[evs.length % EVENT_PALETTE.length];
        }catch(e){ return EVENT_PALETTE[0]; }
      }

      // Return a readable text color (white or dark) for a given hex background
      function readableTextColor(hex){
        try{
          if(!hex) return '#0b8043';
          const c = hex.replace('#','');
          const r = parseInt(c.substr(0,2),16);
          const g = parseInt(c.substr(2,2),16);
          const b = parseInt(c.substr(4,2),16);
          // relative luminance approximation
          const lum = (0.299*r + 0.587*g + 0.114*b) / 255;
          // if very light background, use dark text; otherwise use white
          return lum > 0.65 ? '#0b8043' : '#ffffff';
        }catch(e){ return '#0b8043'; }
      }

      let viewDate = new Date(); // currently viewed month
      let selectedDate = null; // ISO yyyy-mm-dd

      function load(){ try{ return JSON.parse(localStorage.getItem(KEY)) || []; }catch(e){ return []; } }
      function save(items){ localStorage.setItem(KEY, JSON.stringify(items)); }
      // eventsForDay now supports multi-day events (checks if iso is within event date..endDate)
      function eventsForDay(iso){
        return load().filter(e=>{
          if(!e) return false;
          const start = e.date;
          const end = e.endDate || e.date;
          return iso >= start && iso <= end;
        });
      }

      function isoOf(d){ const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const day=('0'+d.getDate()).slice(-2); return `${y}-${m}-${day}` }

      function renderMonth(){
        // header
        const monthName = viewDate.toLocaleString(undefined,{month:'long', year:'numeric'});
        calTitle.textContent = monthName;
        calGrid.innerHTML = '';

        // week day headers
        const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        days.forEach(d=>{ const h = document.createElement('div'); h.style.fontWeight='600'; h.style.padding='6px'; h.style.textAlign='center'; h.style.background='#fff'; h.textContent=d; calGrid.appendChild(h); });

        // first day of month
        const first = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
        const startIndex = first.getDay();
        const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 0).getDate();

        // fill blanks
        for(let i=0;i<startIndex;i++){ const blank = document.createElement('div'); blank.style.padding='12px'; blank.style.background='#fafafa'; calGrid.appendChild(blank); }

        // days
        for(let d=1; d<=daysInMonth; d++){
          const dt = new Date(viewDate.getFullYear(), viewDate.getMonth(), d);
          const iso = isoOf(dt);
          const cell = document.createElement('div');
          cell.style.minHeight='80px';
          cell.style.padding='8px';
          cell.style.borderRadius='6px';
          cell.style.background='#fff';
          cell.style.border='1px solid #eef3f6';
          cell.style.display='flex';
          cell.style.flexDirection='column';
          cell.style.justifyContent='flex-start';
          cell.style.cursor='pointer';

          const top = document.createElement('div'); top.style.display='flex'; top.style.justifyContent='space-between'; top.style.alignItems='center';
          const num = document.createElement('div'); num.style.fontWeight='600'; num.textContent = d;
          const badge = document.createElement('div'); badge.style.fontSize='12px'; badge.style.color='#666';
          top.appendChild(num); top.appendChild(badge);
          cell.appendChild(top);

          // event dots/preview
          const evs = eventsForDay(iso);
            if(evs.length){
            const list = document.createElement('div'); list.style.marginTop='6px'; list.style.display='flex'; list.style.flexDirection='column'; list.style.gap='4px';
            evs.slice(0,3).forEach(ev=>{
              const e = document.createElement('div');
              e.style.fontSize='12px';
              // solid background color for event preview
              const bg = ev.color || '#e8f5e9';
              e.style.background = bg;
              e.style.padding = '6px 8px';
              e.style.borderRadius = '6px';
              e.style.border = 'none';
              e.style.color = readableTextColor(bg);
              e.style.fontWeight = '600';
              e.textContent = (ev.time? ev.time + ' ':'') + ev.title;
              // add a tiny color-change button on hover (for desktop)
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.title = 'Change color';
              btn.style.marginLeft = '8px';
              btn.style.border = 'none';
              btn.style.background = 'transparent';
              btn.style.cursor = 'pointer';
              btn.style.display = 'inline-block';
              btn.style.verticalAlign = 'middle';
              btn.textContent = '●';
              btn.style.color = readableTextColor(bg) === '#ffffff' ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.6)';
              btn.style.fontSize = '14px';
              btn.style.padding = '0 6px';
              btn.addEventListener('click', (evclick)=>{
                evclick.stopPropagation();
                // create a temporary color input and trigger it
                const input = document.createElement('input');
                input.type = 'color';
                input.value = bg;
                input.style.position = 'fixed';
                input.style.left = '-9999px';
                document.body.appendChild(input);
                input.addEventListener('input', (e2)=>{
                  // update the event color in storage
                  const all = load();
                  const idx = all.findIndex(a=> Number(a.createdAt) === Number(ev.createdAt));
                  if(idx!==-1){ all[idx].color = e2.target.value; save(all); renderMonth(); if(selectedDate===all[idx].date) renderEventsForSelected(); }
                });
                input.click();
                setTimeout(()=>{ input.remove(); }, 5000);
              });
              e.appendChild(btn);
              list.appendChild(e);
            });
            if(evs.length>3){ const more = document.createElement('div'); more.style.fontSize='12px'; more.style.color='#999'; more.textContent = `+${evs.length-3} more`; list.appendChild(more); }
            cell.appendChild(list);
          }

          // today highlight
          const todayIso = isoOf(new Date());
          if(iso === todayIso){ cell.style.boxShadow='0 2px 6px rgba(16,24,40,0.06)'; }

          // selected highlight
          if(selectedDate === iso){ cell.style.background='#eef6ff'; cell.style.border='1px solid #cfe6ff'; }

          cell.addEventListener('click', ()=>{ selectedDate = iso; // set date input to selected
            if(dateEl) dateEl.value = iso; renderMonth(); renderEventsForSelected(); });

          calGrid.appendChild(cell);
        }
      }

      function renderEventsForSelected(){
        eventsList.innerHTML = '';
        if(!selectedDate){ selectedDateDisplay.textContent = 'None'; eventsList.innerHTML = '<li class="empty" style="padding:8px;color:#666">Select a date to view events</li>'; return }
        selectedDateDisplay.textContent = selectedDate;
        const evs = eventsForDay(selectedDate);
        if(!evs.length){ eventsList.innerHTML = '<li class="empty" style="padding:8px;color:#666">No events for selected date</li>'; return }
        evs.slice().reverse().forEach((ev, idx)=>{
          const li = document.createElement('li');
          li.style.display='flex';
          li.style.justifyContent='space-between';
          li.style.alignItems='center';
          li.style.padding='10px 12px';
          li.style.borderRadius='8px';
          li.style.marginBottom='8px';
          // use solid background color for the list item and compute readable text color
          const bg = ev.color || '#e8f5e9';
          li.style.background = bg;
          li.style.border = 'none';
          li.style.color = readableTextColor(bg);
          const left = document.createElement('div');
          // compute duration in days
          const start = ev.date || '';
          const end = ev.endDate || ev.date || '';
          let durationText = '';
          try{
            const sd = new Date(start);
            const ed = new Date(end);
            const days = Math.max(1, Math.round((ed - sd)/(24*60*60*1000)) + 1);
            durationText = ` • ${days} day${days>1?'s':''}`;
          }catch(e){ durationText = ''; }
          // removed the middle bullet/dot between time and location per request
          left.innerHTML = `<strong>${escapeHtml(ev.title)}</strong><div style="font-size:13px;color:#555">${ev.time?escapeHtml(ev.time)+' ':' '}${escapeHtml(ev.location||'')}${durationText}</div>`;
          const right = document.createElement('div');
          // color change button (visible)
          const colorBtn = document.createElement('button');
          colorBtn.type = 'button';
          colorBtn.title = 'Change color';
          colorBtn.className = 'btn';
          colorBtn.style.padding = '6px 8px';
          colorBtn.style.marginLeft = '8px';
          colorBtn.style.background = '#ffffff';
          colorBtn.style.border = '1px solid rgba(0,0,0,0.08)';
          colorBtn.textContent = 'Color';
          colorBtn.addEventListener('click', (evclick)=>{
            evclick.stopPropagation();
            const input = document.createElement('input');
            input.type = 'color';
            input.value = ev.color || '#e8f5e9';
            input.style.position = 'fixed';
            input.style.left = '-9999px';
            document.body.appendChild(input);
            input.addEventListener('input', (e2)=>{
              const all = load();
              const idx = all.findIndex(a=> Number(a.createdAt) === Number(ev.createdAt));
              if(idx!==-1){ all[idx].color = e2.target.value; save(all); renderMonth(); renderEventsForSelected(); if(window.logHistory) window.logHistory(`Event recolored: ${all[idx].title} (${all[idx].date})`); }
            });
            input.click();
            setTimeout(()=>{ input.remove(); }, 5000);
          });

          const del = document.createElement('button'); del.className='btn'; del.style.background='#e74c3c'; del.style.padding='6px 8px'; del.style.marginLeft='8px'; del.textContent='Delete';
          // Edit button
          const editBtn = document.createElement('button'); editBtn.className='btn'; editBtn.style.background='#2563EB'; editBtn.style.padding='6px 8px'; editBtn.textContent='Edit';
          editBtn.addEventListener('click', ()=>{ openEventEditModal(ev); });

          del.addEventListener('click', ()=>{ if(!confirm('Remove this event?')) return; let all = load(); // remove the matching event by createdAt
            all = all.filter(a=>!(a.date===selectedDate && a.createdAt===ev.createdAt)); save(all); renderMonth(); renderEventsForSelected(); if(window.logHistory) window.logHistory(`Event deleted: ${ev.title} (${ev.date})`); });
          right.appendChild(editBtn);
          right.appendChild(colorBtn);
          right.appendChild(del);
          li.appendChild(left); li.appendChild(right);
          eventsList.appendChild(li);
        });
      }

      function addEvent(){
        const title = (titleEl && titleEl.value || '').trim();
        const date = dateEl && dateEl.value || selectedDate || '';
        const time = timeEl && timeEl.value || '';
        const location = locEl && locEl.value.trim() || '';
        if(!title) { alert('Event title required'); if(titleEl) titleEl.focus(); return }
        if(!date) { alert('Event date required (select a date or use the date picker)'); if(dateEl) dateEl.focus(); return }
        const items = load();
        // choose color: if user changed the color picker (not the default), use it;
        // otherwise pick the next color from the palette for that date so multiple
        // activities look different.
        const DEFAULT_COLOR = '#e8f5e9';
        let chosenColor = DEFAULT_COLOR;
        if(colorEl && colorEl.value && colorEl.value.toLowerCase() !== DEFAULT_COLOR) {
          chosenColor = colorEl.value;
        } else {
          chosenColor = getNextColorForDate(date);
        }
        const rec = { title, date, endDate: (endDateEl && endDateEl.value) || date, time, location, color: chosenColor, createdAt: Date.now() };
        items.push(rec); save(items);
        if(titleEl) titleEl.value=''; if(timeEl) timeEl.value=''; if(locEl) locEl.value='';
        renderMonth(); renderEventsForSelected(); if(window.logHistory) window.logHistory(`Event added: ${rec.title} (${rec.date}${rec.time? ' ' + rec.time : ''})`);
      }

  addBtn && addBtn.addEventListener('click', addEvent);
  clearBtn && clearBtn.addEventListener('click', ()=>{ if(!confirm('Clear all events?')) return; localStorage.removeItem(KEY); renderMonth(); renderEventsForSelected(); if(window.logHistory) window.logHistory('Cleared all calendar events'); });

  // Edit event modal logic
  const editEventModal = document.getElementById('editEventModal');
  const editEventBackdrop = document.getElementById('editEventBackdrop');
  const editEventTitleInput = document.getElementById('editEventTitleInput');
  const editEventDateInput = document.getElementById('editEventDateInput');
  const editEventEndDateInput = document.getElementById('editEventEndDateInput');
  const editEventTimeInput = document.getElementById('editEventTimeInput');
  const editEventLocationInput = document.getElementById('editEventLocationInput');
  const editEventColorInput = document.getElementById('editEventColorInput');
  const saveEditBtn = document.getElementById('saveEditEvent');
  const cancelEditBtn = document.getElementById('cancelEditEvent');

  let _editingEventCreatedAt = null;

  function openEventEditModal(ev){
    if(!editEventModal) return;
    _editingEventCreatedAt = ev.createdAt;
    editEventTitleInput.value = ev.title || '';
    editEventDateInput.value = ev.date || '';
    editEventEndDateInput.value = ev.endDate || '';
    editEventTimeInput.value = ev.time || '';
    editEventLocationInput.value = ev.location || '';
    editEventColorInput.value = ev.color || '#e8f5e9';
    editEventModal.setAttribute('aria-hidden','false');
  }

  function closeEventEditModal(){
    if(!editEventModal) return;
    editEventModal.setAttribute('aria-hidden','true');
    _editingEventCreatedAt = null;
  }

  cancelEditBtn && cancelEditBtn.addEventListener('click', closeEventEditModal);
  editEventBackdrop && editEventBackdrop.addEventListener('click', closeEventEditModal);

  saveEditBtn && saveEditBtn.addEventListener('click', ()=>{
    const title = (editEventTitleInput.value||'').trim();
    const date = editEventDateInput.value || '';
    const endDate = editEventEndDateInput.value || date;
    const time = editEventTimeInput.value || '';
    const location = editEventLocationInput.value.trim() || '';
    const color = editEventColorInput.value || '#e8f5e9';
    if(!title){ alert('Event title required'); editEventTitleInput.focus(); return }
    if(!date){ alert('Event date required'); editEventDateInput.focus(); return }
    try{
      const all = load();
      const idx = all.findIndex(a=> Number(a.createdAt) === Number(_editingEventCreatedAt));
      if(idx === -1){ alert('Event not found'); closeEventEditModal(); return }
      all[idx].title = title; all[idx].date = date; all[idx].endDate = endDate; all[idx].time = time; all[idx].location = location; all[idx].color = color; all[idx].updatedAt = Date.now();
      save(all);
      if(window.logHistory) window.logHistory(`Event edited: ${title} (${date})`);
      closeEventEditModal();
      renderMonth(); renderEventsForSelected();
    }catch(e){ console.warn('save edit failed', e); alert('Failed to save event'); }
  });

      calPrev && calPrev.addEventListener('click', ()=>{ viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()-1, 1); renderMonth(); });
      calNext && calNext.addEventListener('click', ()=>{ viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 1); renderMonth(); });

      // helper escape
      function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

      // initial
      // set date input default to today
      const todayIso = (new Date()).toISOString().slice(0,10);
      if(dateEl && !dateEl.value) dateEl.value = todayIso;
      selectedDate = todayIso;
      renderMonth(); renderEventsForSelected();
    })();
  </script>
  <script>
    // populate user badge from stored session (cssu_logged_user)
    (function(){
      function readUser(){
        try{
          const s = sessionStorage.getItem('cssu_logged_user');
          if(s) return JSON.parse(s);
          const l = localStorage.getItem('cssu_logged_user');
          if(l) return JSON.parse(l);
        }catch(e){ console.warn('user read failed', e); }
        return null;
      }

      const u = readUser();
      if(!u){
        // if not on login page, redirect
        if(!/login\.html$/i.test(window.location.pathname)) window.location.href = 'login.html';
        return;
      }

      const nameEl = document.getElementById('userName');
      const avatarEl = document.getElementById('userAvatar');
      if(nameEl) nameEl.textContent = (u.name || u.username || 'User');
      if(avatarEl){
        // create initials from name
        const n = (u.name || u.username || 'U').trim();
        const parts = n.split(/\s+/).filter(Boolean);
        const initials = parts.length === 1 ? parts[0].slice(0,1).toUpperCase() : (parts[0].slice(0,1)+parts[parts.length-1].slice(0,1)).toUpperCase();
        avatarEl.textContent = initials;
      }
    })();
  </script>
  <script>
    // Logout + back-navigation protection with robust modal behavior
    (function(){
      function getStoredUser(){
        try{
          const s = sessionStorage.getItem('cssu_logged_user'); if(s) return JSON.parse(s);
          const l = localStorage.getItem('cssu_logged_user'); if(l) return JSON.parse(l);
        }catch(e){ /* ignore */ }
        return null;
      }

      const logoutBtn = document.getElementById('logoutBtn');
      const logoutModal = document.getElementById('logoutModal');
      const logoutBackdrop = document.getElementById('logoutBackdrop');
      const logoutConfirm = document.getElementById('logoutConfirm');
      const logoutCancel = document.getElementById('logoutCancel');

      // helpers to lock scroll
      function disableBackgroundScroll(){ document.documentElement.style.overflow = 'hidden'; document.body.style.overflow = 'hidden'; }
      function enableBackgroundScroll(){ document.documentElement.style.overflow = ''; document.body.style.overflow = ''; }

      let lastFocused = null;

      function openLogoutModal(){
        if(!logoutModal) return;
        lastFocused = document.activeElement;
        logoutModal.setAttribute('aria-hidden','false');
        disableBackgroundScroll();
        // focus the cancel button for safety
        if(logoutCancel) logoutCancel.focus();
        // attach escape handler
        document.addEventListener('keydown', onEscClose);
      }

      function closeLogoutModal(){
        if(!logoutModal) return;
        logoutModal.setAttribute('aria-hidden','true');
        enableBackgroundScroll();
        document.removeEventListener('keydown', onEscClose);
        // restore focus
        try{ if(lastFocused) lastFocused.focus(); }catch(e){}
      }

      function onEscClose(e){ if(e.key === 'Escape') closeLogoutModal(); }

      if(logoutBtn && logoutModal){
        logoutBtn.addEventListener('click', function(e){ e.preventDefault(); openLogoutModal(); });
      }

      if(logoutBackdrop) logoutBackdrop.addEventListener('click', closeLogoutModal);
      if(logoutCancel) logoutCancel.addEventListener('click', closeLogoutModal);

      if(logoutConfirm){
        logoutConfirm.addEventListener('click', function(){
          try{ sessionStorage.removeItem('cssu_logged_user'); localStorage.removeItem('cssu_logged_user'); }catch(err){}
          if(window.logHistory) window.logHistory('User logged out');
          // ensure scroll restored before redirect
          enableBackgroundScroll();
          // small timeout to allow restoration
          setTimeout(()=> window.location.replace('login.html?signedout=1'), 50);
        });
      }

      // protect against bfcache/back: if page becomes visible and no session exists, send to login
      window.addEventListener('pageshow', function(){
        if(!getStoredUser()){
          if(!/login\.html$/i.test(window.location.pathname)){
            window.location.replace('login.html');
          }
        }
      });
    })();
  </script>
</body>
</html>
