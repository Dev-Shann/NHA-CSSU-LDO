<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title></title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }

    body {
      display: flex;
      min-height: 100vh;
      background: #f5f6fa;
    }

    /* Sidebar */
    .sidebar {
      width: 250px;
      background: #2f3640;
      color: #f5f6fa;
      padding: 20px;
      position: fixed;
      height: 100%;
      transition: 0.3s ease;
    }

    .sidebar h2 {
      text-align: center;
      margin-bottom: 40px;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 12px; /* consistent vertical spacing between items */
    }

    .sidebar ul li {
      margin: 0; /* spacing handled by gap on the ul */
    }

    .sidebar ul li a {
      color: #f5f6fa;
      text-decoration: none;
      display: flex;              /* align icon + label */
      align-items: center;
      gap: 12px;                 /* horizontal gap between icon and text */
      padding: 10px 15px;
      border-radius: 8px;
      transition: background 0.3s;
    }

    .sidebar ul li a:hover {
      background: #40739e;
    }

    /* Sidebar submenu */
    .nav .submenu { list-style:none; margin:8px 0 0 8px; padding-left:0; display:none }
    .nav .submenu li { margin:6px 0 }
    .nav .submenu li a { padding:6px 10px; display:block; border-radius:6px; color:#e7f0f7 }
    .nav .has-submenu > a { cursor:pointer }

    /* Main content */
    .main {
      margin-left: 250px;
      flex: 1;
      padding: 20px;
      transition: 0.3s;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 15px 25px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .topbar h1 {
      font-size: 22px;
      color: #2f3640;
    }

    .toggle-btn {
      display: none;
      font-size: 22px;
      cursor: pointer;
      color: #2f3640;
    }

    /* Cards */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: start;
    }

    .card h3 {
      margin-bottom: 10px;
      color: #40739e;
    }

    .card p {
      font-size: 18px;
      font-weight: 600;
      color: #2f3640;
    }

    /* Announcements */
    .announcements-card { text-align: left; padding: 16px; margin-bottom: 16px }
    .ann-controls { display:flex; gap:8px; margin-bottom:12px }
    .ann-controls input { flex:1; padding:10px; border-radius:8px; border:1px solid #e6e9ee }
    .ann-controls button { padding:8px 12px; background:#40739e; color:#fff; border:none; border-radius:8px }
    .announcement-list { list-style:none; padding-left:0 }
    .announcement-list li { padding:10px; border-radius:8px; background:#fbfdff; border:1px solid #eef3f6; margin-bottom:8px; display:flex; justify-content:space-between; gap:8px }
    .announcement-actions button { padding:6px 8px; border-radius:6px; border:none; cursor:pointer }
    .announcement-actions .edit { background:#f7fbfd; border:1px solid #d9e3ea }
    .announcement-actions .del { background:#ffefef; border:1px solid #ffd6d6; color:#c0392b }

    /* To-Do Board */
    .todo-board {
      background: white;
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin: 20px 0;
    }

    .todo-board h3 { color: #2f3640; margin-bottom: 12px; }

  .todo-progress { display:flex; align-items:center; gap:12px; margin-bottom:12px }
  .progress-bar { flex:1; height:12px; background:#eef3f6; border-radius:8px; overflow:hidden; }
  .progress-fill { height:100%; width:0%; background: linear-gradient(90deg,#2ecc71,#f1c40f); transition: width 300ms ease; }
  .progress-text { min-width:48px; text-align:right; font-weight:600; color:#2f3640 }

  /* Modal (edit task) */
  .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 2000; }
  .modal[aria-hidden="false"] { display: flex; }
  .modal-backdrop { position: absolute; inset: 0; background: rgba(16,24,40,0.25); }
  .modal-content { position: relative; background: #ffffff; padding: 20px; border-radius: 12px; width: 360px; box-shadow: 0 12px 30px rgba(16,24,40,0.08); border: 1px solid #eef3f8; z-index: 2; }
  .modal-content h4 { margin-bottom: 8px; color:#0f172a }
  .modal-content p { color:#475569 }
  .modal-content input { width: 100%; padding:8px 10px; margin-bottom:10px; border-radius:8px; border:1px solid #e6eef6 }
  .modal-actions { display:flex; gap:8px; justify-content:flex-end }
  .modal-actions button { padding:8px 12px; border-radius:8px; border:none; color:white }
  .modal-actions .primary { background:#2563EB }
  .modal-actions .secondary { background:#bdc3c7; color:#0f172a }
  .modal-actions .danger { background: #ef4444 }

    .todo-controls { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
    .todo-controls input[type="text"] {
      flex: 1;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #e6e9ee;
      outline: none;
    }
    .todo-controls button {
      padding: 8px 10px;
      background: #40739e;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
    }

    #importFile { display: none; }

    .columns {
      display: grid;
      grid-template-columns: repeat(4, 1fr); /* 4 columns: pending, inprogress, completed, done */
      gap: 12px;
    }

    .column {
      background: #fbfdff;
      border: 1px solid #eef3f6;
      padding: 12px;
      border-radius: 8px;
      min-height: 120px;
    }

    /* Status color variants */
    .column[data-status="pending"] {
      background: #fff6f6; /* soft red */
      border-color: #ffd6d6;
    }
    .column[data-status="inprogress"] {
      background: #fffdf5; /* soft yellow */
      border-color: #fff1c6;
    }
    .column[data-status="completed"] {
      background: #f6fff7; /* soft green */
      border-color: #dff6e8;
    }
    /* Task accent bar per status */
    .column[data-status="pending"] .task { box-shadow: 0 1px 3px rgba(231,76,60,0.06); border-left: 6px solid #e74c3c; }
    .column[data-status="inprogress"] .task { box-shadow: 0 1px 3px rgba(241,196,15,0.06); border-left: 6px solid #f1c40f; }
    .column[data-status="completed"] .task { box-shadow: 0 1px 3px rgba(46,204,113,0.06); border-left: 6px solid #2ecc71; }

    /* Slightly darker title for contrast */
    .column[data-status="pending"] .task-title { color: #b03a2e; }
    .column[data-status="inprogress"] .task-title { color: #a07b0a; }
    .column[data-status="completed"] .task-title { color: #1e8449; }
    

    .column h4 { font-size: 16px; margin-bottom: 8px; display:flex; justify-content:space-between; align-items:center; }

    .task-list { display: flex; flex-direction: column; gap: 8px; }

    .task {
      background: white;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .task-title { flex: 1; color: #2f3640; }

    .task-meta { display:flex; gap:6px; align-items:center; }

    .task-btn {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d9e3ea;
      background: #f7fbfd;
      cursor: pointer;
      font-size: 13px;
    }

    .task-btn.small { padding: 6px 8px; font-size: 14px; }
    .task-btn.danger { background: #ffefef; border-color: #ffd6d6; color: #c0392b; }

    @media (max-width: 900px) {
      .columns { grid-template-columns: 1fr; }
    }

    /* Chart */
    .chart-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 20px;
    }

    canvas {
      width: 100% !important;
      height: 300px !important;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 200px;
        position: absolute;
        left: -200px;
        z-index: 100;
      }

      .sidebar.active {
        left: 0;
      }

      .toggle-btn {
        display: block;
      }

      .main {
        margin-left: 0;
      }
    }
    @media (max-width: 500px) {
      .topbar h1 {
        font-size: 18px;
      }
    }

  </style>
</head>
<body>
   <div class="sidebar">
    <h2>DASHBOARD</h2>
    <ul class="nav">
      <li><a href="index.html" class="active"><span class="nav-icon">üè†</span><span>Dashboard</span></a></li>
       <li><a href="hoa.html" class="active"><span class="nav-icon" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm6 1c-1.66 0-3 1.34-3 3v3h6v-3c0-1.66-1.34-3-3-3zM6 13c-1.66 0-3 1.34-3 3v3h6v-3c0-1.66-1.34-3-3-3z" fill="currentColor"/></svg></span><span>Homeowners</span></a></li>
      <li><a href="tracking.html" class="active"><span class="nav-icon" aria-hidden="true"><img src="tracking.png" alt="" height="20" width="20"></span><span>Tracking</span></a></li>
    </ul>
    <!-- Logout placed at bottom of sidebar for easier access on mobile/desktop -->
    <ul class="nav logout-nav" style="position:absolute;bottom:20px;left:20px;right:20px;padding:0;margin:0;">
      <li style="margin:0">
        <a href="#" id="logoutBtn" role="button" aria-haspopup="dialog"><span class="nav-icon">üö™</span><span>Logout</span></a>
      </li>
    </ul>
  </div>
   <div id="logoutModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" id="logoutBackdrop"></div>
    <div class="modal-content" role="dialog" aria-modal="true">
      <h4>Logout</h4>
      <p>Are you sure you want to logout of your account?</p>
      <div class="modal-actions" style="margin-top:12px">
        <button id="logoutCancel" class="primary">Cancel</button>
        <button id="logoutConfirm" class="danger">Logout</button>
      </div>
    </div>
  </div>

  <script>
    // Sidebar homeowners submenu toggle
    (function(){
      const toggle = document.getElementById('homeownersToggle');
      if(!toggle) return;
      const li = toggle.closest('.has-submenu');
      const submenu = li.querySelector('.submenu');
      toggle.addEventListener('click', (e)=>{
        e.preventDefault();
        const open = submenu.style.display === 'block';
        submenu.style.display = open ? 'none' : 'block';
      });
    })();
  </script>

  <div class="main">
    <div class="topbar">
      <span class="toggle-btn" id="toggle-btn">‚ò∞</span>
      <h1>Tracking Overview</h1>
      <div id="userMenu" style="display:flex;align-items:center;gap:10px">
       
      </div>
    </div>

    

    <!-- To-Do Board -->
    <div class="todo-board" aria-label="To-Do Board">
      <h3>Tracking</h3>
      <div class="todo-progress" aria-hidden="false">
        <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <div class="progress-fill" id="todoProgressFill" style="width:0%"></div>
        </div>
        <div class="progress-text" id="todoProgressText">0%</div>
      </div>

      <!-- Edit Modal removed per request -->

      <!-- Delete Confirmation Modal -->
      <div id="deleteModal" class="modal" aria-hidden="true">
        <div class="modal-backdrop" id="deleteBackdrop"></div>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="deleteTitle">
          <h4 id="deleteTitle">Delete Task</h4>
          <p id="deleteMessage">Are you sure you want to delete this task?</p>
          <div class="modal-actions">
            <button id="deleteConfirm" style="background:#c0392b">Delete</button>
            <button id="deleteCancel" style="background:#4236c4" bg-dark>Cancel</button>
          </div>
        </div>
      </div>

      <div class="todo-controls">
        <input id="newTaskInput" type="text" placeholder="Add a new tracking and press Enter or click Add" />
        <button id="addTaskBtn">Add</button>
        <button id="clearCompletedBtn" title="Clear all completed">Clear Completed</button>
        <button id="exportBtn" title="Export tasks as JSON">Export</button>
        <button id="importBtn" title="Import tasks from JSON">Import</button>
        <input id="importFile" type="file" accept="application/json" />
      </div>

      <div class="columns">
        <div class="column" data-status="pending">
          <h4>CSSU <span id="count-pending">0</span></h4>
          <div class="task-list" id="pendingList"></div>
        </div>

        <div class="column" data-status="inprogress">
          <h4>IRAH SECRETARY <span id="count-inprogress">0</span></h4>
          <div class="task-list" id="inprogressList"></div>
        </div>

        <div class="column" data-status="completed">
          <h4>MAIN OFFICE Q.C <span id="count-completed">0</span></h4>
          <div class="task-list" id="completedList"></div>
        </div>

        <div class="column" data-status="done">
          <h4>BACK TO CSSU LAGUNA <span id="count-done">0</span></h4>
          <div class="task-list" id="doneList"></div>
        </div>
      </div>
    </div>
<script>
    // Logout + back-navigation protection with robust modal behavior
    (function(){
      function getStoredUser(){
        try{
          const s = sessionStorage.getItem('cssu_logged_user'); if(s) return JSON.parse(s);
          const l = localStorage.getItem('cssu_logged_user'); if(l) return JSON.parse(l);
        }catch(e){ /* ignore */ }
        return null;
      }

      const logoutBtn = document.getElementById('logoutBtn');
      const logoutModal = document.getElementById('logoutModal');
      const logoutBackdrop = document.getElementById('logoutBackdrop');
      const logoutConfirm = document.getElementById('logoutConfirm');
      const logoutCancel = document.getElementById('logoutCancel');

      // helpers to lock scroll
      function disableBackgroundScroll(){ document.documentElement.style.overflow = 'hidden'; document.body.style.overflow = 'hidden'; }
      function enableBackgroundScroll(){ document.documentElement.style.overflow = ''; document.body.style.overflow = ''; }

      let lastFocused = null;

      function openLogoutModal(){
        if(!logoutModal) return;
        lastFocused = document.activeElement;
        logoutModal.setAttribute('aria-hidden','false');
        disableBackgroundScroll();
        if(logoutCancel) logoutCancel.focus();
        document.addEventListener('keydown', onEscClose);
      }

      function closeLogoutModal(){
        if(!logoutModal) return;
        logoutModal.setAttribute('aria-hidden','true');
        enableBackgroundScroll();
        document.removeEventListener('keydown', onEscClose);
        try{ if(lastFocused) lastFocused.focus(); }catch(e){}
      }

      function onEscClose(e){ if(e.key === 'Escape') closeLogoutModal(); }

      if(logoutBtn && logoutModal){
        logoutBtn.addEventListener('click', function(e){ e.preventDefault(); openLogoutModal(); });
      }

      if(logoutBackdrop) logoutBackdrop.addEventListener('click', closeLogoutModal);
      if(logoutCancel) logoutCancel.addEventListener('click', closeLogoutModal);

      if(logoutConfirm){
        logoutConfirm.addEventListener('click', function(){
          try{ sessionStorage.removeItem('cssu_logged_user'); localStorage.removeItem('cssu_logged_user'); }catch(err){}
          enableBackgroundScroll();
          setTimeout(()=> window.location.replace('login.html?signedout=1'), 50);
        });
      }

      // protect against bfcache/back: if page becomes visible and no session exists, send to login
      window.addEventListener('pageshow', function(){
        if(!getStoredUser()){
          if(!/login\.html$/i.test(window.location.pathname)){
            window.location.replace('login.html');
          }
        }
      });
    })();
  </script>
    

 
  <script>
    const CATEGORIES = ['EHAP','EPHAP','888','FOI','CBTAP','CONDONATION','GAD','COHSEP'];
    const DB_NAME = 'rdtfDB';
    const STORE_NAME = 'files';
    let db;

    function openDB(){
      return new Promise((resolve,reject)=>{
        const req = indexedDB.open(DB_NAME,1);
        req.onupgradeneeded = (e)=>{ const idb = e.target.result; if(!idb.objectStoreNames.contains(STORE_NAME)) idb.createObjectStore(STORE_NAME,{ keyPath:'tracker', autoIncrement:true }); };
        req.onsuccess = ()=>{ db = req.result; resolve(db); };
        req.onerror = ()=> reject(req.error);
      });
    }

    function addFileRecord(rec){ return new Promise((resolve,reject)=>{ const tx = db.transaction(STORE_NAME,'readwrite'); const store = tx.objectStore(STORE_NAME); const req = store.add(rec); req.onsuccess = e=> resolve(e.target.result); req.onerror = ()=> reject(req.error); }); }
    function getAllFiles(){ return new Promise((resolve,reject)=>{ const tx = db.transaction(STORE_NAME,'readonly'); const store = tx.objectStore(STORE_NAME); const req = store.getAll(); req.onsuccess = ()=> resolve(req.result); req.onerror = ()=> reject(req.error); }); }
    function getFile(id){ return new Promise((resolve,reject)=>{ const tx = db.transaction(STORE_NAME,'readonly'); const store = tx.objectStore(STORE_NAME); const req = store.get(Number(id)); req.onsuccess = ()=> resolve(req.result); req.onerror = ()=> reject(req.error); }); }
    function updateRecord(rec){ return new Promise((resolve,reject)=>{ const tx = db.transaction(STORE_NAME,'readwrite'); const store = tx.objectStore(STORE_NAME); const req = store.put(rec); req.onsuccess = ()=> resolve(req.result); req.onerror = ()=> reject(req.error); }); }
    function deleteRecord(id){ return new Promise((resolve,reject)=>{ const tx = db.transaction(STORE_NAME,'readwrite'); const store = tx.objectStore(STORE_NAME); const req = store.delete(Number(id)); req.onsuccess = ()=> resolve(); req.onerror = ()=> reject(req.error); }); }

  const categoryInput = document.getElementById('categoryInput');
  const titleInput = document.getElementById('titleInput');
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const viewModalEl = document.getElementById('viewModal');
  const viewContent = document.getElementById('viewContent');
  const downloadLink = document.getElementById('downloadLink');
  const closeViewBtn = document.getElementById('closeViewBtn');
  const fromDate = document.getElementById('fromDate');
  const toDate = document.getElementById('toDate');
  const categoryFilter = document.getElementById('categoryFilter');
  const clearDates = document.getElementById('clearDates');
  const perPageSelect = document.getElementById('perPageSelect');
  const filesTbody = document.getElementById('filesTbody');
  const totalCountEl = document.getElementById('totalCount');
  const prevPage = document.getElementById('prevPage');
  const nextPage = document.getElementById('nextPage');
  const paginationInfo = document.getElementById('paginationInfo');
  
  const editTitle = document.getElementById('editTitle');
  const editCategory = document.getElementById('editCategory');
  const cancelEdit = document.getElementById('cancelEdit');
  const saveEdit = document.getElementById('saveEdit');

  function populateCategories(){ categoryInput.innerHTML = '<option value="">(detect)</option>' + CATEGORIES.map(c=>`<option value="${c}">${c}</option>`).join(''); editCategory.innerHTML = '<option value="">(detect)</option>' + CATEGORIES.map(c=>`<option value="${c}">${c}</option>`).join(''); }
      // also populate top category filter
      function populateCategoryFilter(){
        if(!categoryFilter) return;
        categoryFilter.innerHTML = '<option value="">All</option>' + CATEGORIES.map(c=>`<option value="${c}">${c}</option>`).join('');
      }
    function detectCategory(name){ if(!name) return ''; const lower = name.toLowerCase(); for(const c of CATEGORIES) if(lower.includes(c.toLowerCase())) return c; return ''; }
    function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }
    function bytesToSize(bytes){ if(!bytes) return '0 B'; const k=1024; const sizes=['B','KB','MB','GB']; const i=Math.floor(Math.log(bytes)/Math.log(k)); return parseFloat((bytes/Math.pow(k,i)).toFixed(2)) + ' ' + sizes[i]; }
    function colorClassFor(cat){ return 'c-' + (cat||'').toUpperCase().replace(/\s+/g,'').replace(/[^A-Z0-9]/g,''); }

    // Table rendering with filter + pagination
    let state = { all: [], filtered: [], page: 1, perPage: Number(perPageSelect.value) || 10 };

    function applyFilters(){
      const from = fromDate.value ? new Date(fromDate.value).setHours(0,0,0,0) : null;
      const to = toDate.value ? new Date(toDate.value).setHours(23,59,59,999) : null;
      const cat = categoryFilter && categoryFilter.value ? categoryFilter.value : '';
      state.filtered = state.all.filter(rec=>{
        if(from && rec.createdAt < from) return false;
        if(to && rec.createdAt > to) return false;
        const recCat = rec.category || detectCategory(rec.name) || '';
        if(cat && recCat !== cat) return false;
        return true;
      }).sort((a,b)=> (Number(a.tracker) || 0) - (Number(b.tracker) || 0) );
      state.page = 1; // reset to first page when filters change
    }

    function renderTable(){
      const total = state.filtered.length;
      totalCountEl.textContent = total;
      const per = state.perPage;
      const pages = Math.max(1, Math.ceil(total / per));
      if(state.page > pages) state.page = pages;
      const start = (state.page - 1) * per;
      const pageItems = state.filtered.slice(start, start + per);

      filesTbody.innerHTML = '';
      for(const rec of pageItems){
        const tr = document.createElement('tr');
        const trackerTd = document.createElement('td'); trackerTd.style.padding='8px'; trackerTd.textContent = rec.tracker || '';
        tr.appendChild(trackerTd);
        const titleTd = document.createElement('td'); titleTd.style.padding='8px'; titleTd.textContent = rec.title || rec.name; tr.appendChild(titleTd);
        const nameTd = document.createElement('td'); nameTd.style.padding='8px'; nameTd.textContent = rec.name; tr.appendChild(nameTd);
        const catTd = document.createElement('td'); catTd.style.padding='8px'; catTd.textContent = rec.category || detectCategory(rec.name) || 'Uncategorized'; tr.appendChild(catTd);
        const sizeTd = document.createElement('td'); sizeTd.style.padding='8px'; sizeTd.style.textAlign='right'; sizeTd.textContent = bytesToSize(rec.size||0); tr.appendChild(sizeTd);
        const createdTd = document.createElement('td'); createdTd.style.padding='8px'; createdTd.textContent = new Date(rec.createdAt).toLocaleString(); tr.appendChild(createdTd);
        const actionsTd = document.createElement('td'); actionsTd.style.padding='8px'; actionsTd.style.textAlign='center';
        const viewBtn = document.createElement('button'); viewBtn.className='btn'; viewBtn.style.padding='6px 8px'; viewBtn.textContent='View'; viewBtn.addEventListener('click', ()=>openView(rec.tracker)); actionsTd.appendChild(viewBtn);
        const updateBtn = document.createElement('button'); updateBtn.className='btn'; updateBtn.style.marginLeft='6px'; updateBtn.style.background='#16a085'; updateBtn.textContent='Update'; updateBtn.addEventListener('click', ()=>openUpdate(rec.tracker)); actionsTd.appendChild(updateBtn);
        const delBtn = document.createElement('button'); delBtn.className='btn danger'; delBtn.style.marginLeft='6px'; delBtn.style.background='var(--danger)'; delBtn.textContent='Delete'; delBtn.addEventListener('click', ()=>confirmDelete(rec.tracker)); actionsTd.appendChild(delBtn);
        tr.appendChild(actionsTd);
        filesTbody.appendChild(tr);
      }

      paginationInfo.textContent = `Page ${state.page} / ${pages}`;
      prevPage.disabled = state.page <= 1; nextPage.disabled = state.page >= pages;
    }

    async function refreshAndRender(){
      state.all = await getAllFiles() || [];
      applyFilters();
      renderTable();
    }

    uploadBtn.addEventListener('click', async ()=>{
      const f = fileInput.files && fileInput.files[0]; if(!f){ alert('Choose a file'); return; }
      const title = titleInput.value.trim() || f.name;
      let category = categoryInput.value || '';
      if(!category) category = detectCategory(f.name) || '';
      const rec = { name:f.name, type:f.type, size:f.size, title, category, data: f, createdAt: Date.now(), updatedAt: Date.now() };
      await addFileRecord(rec);
      titleInput.value=''; fileInput.value=''; categoryInput.value='';
      await refreshAndRender();
    });

    async function openView(id){ const rec = await getFile(id); if(!rec) return alert('Not found'); viewContent.innerHTML=''; const header = document.createElement('div'); header.innerHTML = `<strong>${escapeHtml(rec.title)}</strong><div style="color:#666">${escapeHtml(rec.name)}</div>`; viewContent.appendChild(header); const blob = rec.data instanceof Blob ? rec.data : new Blob([rec.data],{type:rec.type}); const url = URL.createObjectURL(blob); downloadLink.href = url; downloadLink.download = rec.name || 'file'; if(rec.type && rec.type.startsWith('image/')){ const img = document.createElement('img'); img.src=url; img.style.maxWidth='100%'; img.style.borderRadius='6px'; viewContent.appendChild(img); } else if((rec.type && rec.type.startsWith('text/')) || rec.name.match(/\.txt$|\.md$|\.csv$|\.json$/i)){ const fr = new FileReader(); fr.onload = ()=>{ const pre = document.createElement('pre'); pre.textContent = fr.result; viewContent.appendChild(pre); }; fr.readAsText(blob); }
      viewModalEl.setAttribute('open',''); }

  // Open Edit Modal
  let editingId = null;
  function openEditModal(id){ editingId = id; getFile(id).then(rec=>{ editTitle.value = rec.title || rec.name; editCategory.value = rec.category || ''; editModal.setAttribute('open',''); }); }

  cancelEdit.addEventListener('click', ()=>{ editModal.removeAttribute('open'); editingId = null; });
  saveEdit.addEventListener('click', async ()=>{ if(!editingId) return; const rec = await getFile(editingId); rec.title = editTitle.value.trim()||rec.name; rec.category = editCategory.value||rec.category; rec.updatedAt = Date.now(); await updateRecord(rec); editModal.removeAttribute('open'); editingId = null; await refreshAndRender(); });

  function openUpdate(id){ const input = document.createElement('input'); input.type='file'; input.onchange = async ()=>{ const f = input.files[0]; if(!f) return; const rec = await getFile(id); rec.data = f; rec.name = f.name; rec.type = f.type; rec.size = f.size; rec.updatedAt = Date.now(); if(!rec.category) rec.category = detectCategory(f.name)||''; await updateRecord(rec); await refreshAndRender(); }; input.click(); }

  async function confirmDelete(id){ if(!confirm('Delete this file?')) return; await deleteRecord(id); await refreshAndRender(); }

  // Pagination & filters
  fromDate.addEventListener('change', ()=>{ applyFilters(); renderTable(); });
  toDate.addEventListener('change', ()=>{ applyFilters(); renderTable(); });
  categoryFilter && categoryFilter.addEventListener('change', ()=>{ applyFilters(); renderTable(); });
  clearDates.addEventListener('click', ()=>{ fromDate.value=''; toDate.value=''; applyFilters(); renderTable(); });
  perPageSelect.addEventListener('change', ()=>{ state.perPage = Number(perPageSelect.value); state.page = 1; renderTable(); });
  prevPage.addEventListener('click', ()=>{ if(state.page>1){ state.page--; renderTable(); } });
  nextPage.addEventListener('click', ()=>{ const pages = Math.max(1, Math.ceil(state.filtered.length/state.perPage)); if(state.page<pages){ state.page++; renderTable(); } });

  closeViewBtn.addEventListener('click', ()=> viewModalEl.removeAttribute('open'));

  (async function(){ await openDB(); populateCategories(); populateCategoryFilter(); await refreshAndRender(); })();
  </script>

  <!-- Fallback: ensure Edit Task modal Cancel/backdrop always close the modal -->
  <script>
    (function(){
      try{
        const modalEl = document.getElementById('editModal');
        const cancelBtn = document.getElementById('modalCancel');
        const backdrop = document.getElementById('modalBackdrop');
        function hide(){ if(modalEl) modalEl.setAttribute('aria-hidden','true'); }
        if(cancelBtn) cancelBtn.addEventListener('click', hide);
        if(backdrop) backdrop.addEventListener('click', hide);
        // also support Escape key as a fallback
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hide(); });
      }catch(err){ console.warn('modal fallback init failed', err); }
    })();
  </script>

   

  <script>
   

    /* ----------------------------
       To-Do List Functionality
       ---------------------------- */
    (function(){
      const STORAGE_KEY = 'todoTasks_v1';
      let tasks = [];

      // Elements
      const newTaskInput = document.getElementById('newTaskInput');
      const addTaskBtn = document.getElementById('addTaskBtn');
      const pendingList = document.getElementById('pendingList');
      const inprogressList = document.getElementById('inprogressList');
      const completedList = document.getElementById('completedList');
      const doneList = document.getElementById('doneList');
      const counts = {
        pending: document.getElementById('count-pending'),
        inprogress: document.getElementById('count-inprogress'),
        completed: document.getElementById('count-completed'),
        done: document.getElementById('count-done')
      };

      function save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
      }

      function load() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          tasks = raw ? JSON.parse(raw) : [];
        } catch (e) {
          tasks = [];
          console.error('Failed to load tasks', e);
        }
      }

      function uid() {
        return Date.now().toString(36) + Math.random().toString(36).slice(2,8);
      }

      function addTask(title) {
        if (!title || !title.trim()) return;
        const task = {
          id: uid(),
          title: title.trim(),
          status: 'pending',
          createdAt: Date.now()
        };
        tasks.push(task);
        save();
        render();
      }

      function deleteTask(id) {
        tasks = tasks.filter(t => t.id !== id);
        save();
        render();
      }

      

      // Edit modal and editTask removed per request

      // Delete modal state
      let deletingId = null;

      function openDeleteModal(id, title) {
        deletingId = id;
        const modal = document.getElementById('deleteModal');
        const msg = document.getElementById('deleteMessage');
        msg.textContent = `Delete "${title}"? This action cannot be undone.`;
        modal.setAttribute('aria-hidden', 'false');
      }

      function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.setAttribute('aria-hidden', 'true');
        deletingId = null;
      }

      function confirmDelete() {
        if (!deletingId) return closeDeleteModal();
        deleteTask(deletingId);
        closeDeleteModal();
      }

      function moveTask(id, toStatus) {
        const task = tasks.find(t => t.id === id);
        if (!task) return;
        const prev = task.status;
        task.status = toStatus;
        // if moved to done, record to daily archive
        if (toStatus === 'done' && prev !== 'done') {
          try { saveToArchive(task); } catch(e){ console.error('archive', e); }
        }
        save();
        render();
      }

      function createTaskNode(task) {
        const el = document.createElement('div');
        el.className = 'task';
        el.setAttribute('data-id', task.id);

        const title = document.createElement('div');
        title.className = 'task-title';
        title.textContent = task.title;
        el.appendChild(title);

        const meta = document.createElement('div');
        meta.className = 'task-meta';

        // (Arrows removed per request)

        if (task.status === 'done' && task.file) {
          const viewBtn = document.createElement('button');
          viewBtn.className = 'task-btn';
          viewBtn.textContent = 'View';
          viewBtn.addEventListener('click', () => {
            const url = URL.createObjectURL(task.file);
            window.open(url, '_blank');
          });
          meta.appendChild(viewBtn);

          const dlBtn = document.createElement('button');
          dlBtn.className = 'task-btn';
          dlBtn.textContent = 'Download';
          dlBtn.addEventListener('click', () => {
            const url = URL.createObjectURL(task.file);
            const a = document.createElement('a');
            a.href = url;
            a.download = task.file.name || 'file';
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 1000);
          });
          meta.appendChild(dlBtn);
        }

  // edit button removed per request

        const delBtn = document.createElement('button');
        delBtn.className = 'task-btn danger';
        delBtn.title = 'Delete';
        delBtn.textContent = 'Delete';
        delBtn.addEventListener('click', () => openDeleteModal(task.id, task.title));
        meta.appendChild(delBtn);

        el.appendChild(meta);
        return el;
      }

      function render() {
        // clear
        pendingList.innerHTML = '';
        inprogressList.innerHTML = '';
        completedList.innerHTML = '';
        doneList.innerHTML = '';

        const byStatus = {
          pending: tasks.filter(t => t.status === 'pending'),
          inprogress: tasks.filter(t => t.status === 'inprogress'),
          completed: tasks.filter(t => t.status === 'completed'),
          done: tasks.filter(t => t.status === 'done')
        };

        byStatus.pending.forEach(t => pendingList.appendChild(createTaskNode(t)));
        byStatus.inprogress.forEach(t => inprogressList.appendChild(createTaskNode(t)));
        byStatus.completed.forEach(t => completedList.appendChild(createTaskNode(t)));
        byStatus.done.forEach(t => doneList.appendChild(createTaskNode(t)));

        counts.pending.textContent = byStatus.pending.length;
        counts.inprogress.textContent = byStatus.inprogress.length;
        counts.completed.textContent = byStatus.completed.length;
        counts.done.textContent = byStatus.done.length;

        // update overall progress
        const total = tasks.length;
        const completedCount = byStatus.completed.length + byStatus.done.length;
        const percent = total === 0 ? 0 : Math.round((completedCount / total) * 100);
        const fill = document.getElementById('todoProgressFill');
        const text = document.getElementById('todoProgressText');
        if (fill) fill.style.width = percent + '%';
        if (text) text.textContent = percent + '%';
      }

      function allowDrop(ev) {
        ev.preventDefault();
      }

      function onDragStart(ev) {
        ev.dataTransfer.setData('text/plain', ev.target.getAttribute('data-id'));
        ev.dataTransfer.effectAllowed = 'move';
      }

      function wireDnD() {
        // delegate drag events on task elements after render
        [pendingList, inprogressList, completedList].forEach(list => {
          const column = list.closest('.column');
          column.addEventListener('dragover', allowDrop);
          column.addEventListener('drop', (ev) => {
            ev.preventDefault();
            const id = ev.dataTransfer.getData('text/plain');
            const toStatus = column.getAttribute('data-status');
            moveTask(id, toStatus);
          });
        });
      }

      // Inline edit functionality removed per request
      function enhanceTaskNode(el, task) {
        // set draggable
        el.setAttribute('draggable', 'true');
        el.addEventListener('dragstart', onDragStart);
      }

      // override createTaskNode to call enhanceTaskNode before returning
      const _createTaskNode = createTaskNode;
      createTaskNode = function(task) {
        const node = _createTaskNode(task);
        enhanceTaskNode(node, task);
        return node;
      };

      // export tasks as JSON file
      function exportTasks() {
        const data = JSON.stringify(tasks, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'tasks.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // import tasks from JSON File/Blob
      function importTasksFromJSON(json) {
        try {
          const arr = JSON.parse(json);
          if (!Array.isArray(arr)) throw new Error('Invalid format');
          // minimal validation
          tasks = arr.map(t => ({ id: t.id || uid(), title: t.title || 'Untitled', status: t.status || 'pending', createdAt: t.createdAt || Date.now() }));
          save();
          render();
        } catch (e) {
          alert('Failed to import tasks: ' + e.message);
        }
      }

      function clearCompleted() {
        if (!confirm('Clear all completed tasks?')) return;
        tasks = tasks.filter(t => t.status !== 'completed');
        save();
        render();
      }

      function init() {
        load();
        render();
        wireDnD();

        addTaskBtn.addEventListener('click', () => {
          addTask(newTaskInput.value);
          newTaskInput.value = '';
          newTaskInput.focus();
        });

        newTaskInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            addTask(newTaskInput.value);
            newTaskInput.value = '';
          }
        });

        // wire export/import/clear controls
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        const clearCompletedBtn = document.getElementById('clearCompletedBtn');

        exportBtn.addEventListener('click', exportTasks);
        clearCompletedBtn.addEventListener('click', clearCompleted);

        importBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => importTasksFromJSON(reader.result);
          reader.readAsText(file);
          importFile.value = '';
        });

        // delete modal wiring
        const deleteModal = document.getElementById('deleteModal');
        const deleteConfirm = document.getElementById('deleteConfirm');
        const deleteCancel = document.getElementById('deleteCancel');
        const deleteBackdrop = document.getElementById('deleteBackdrop');

        deleteConfirm.addEventListener('click', confirmDelete);
        deleteCancel.addEventListener('click', closeDeleteModal);
        deleteBackdrop.addEventListener('click', closeDeleteModal);
  // edit modal removed; dblclick edit removed

  
      }

      // initialize
      init();
    })();
  
    /* Announcements module */
    (function(){
      const KEY = 'dashboardAnnouncements_v1';
      let anns = [];
      const listEl = document.getElementById('announcementList');
      const input = document.getElementById('announcementInput');
      const addBtn = document.getElementById('addAnnouncementBtn');

      function save() { localStorage.setItem(KEY, JSON.stringify(anns)); }
      function load() { try { anns = JSON.parse(localStorage.getItem(KEY)) || []; } catch(e){ anns = []; } }

      let editingIndex = null;
      let deletingIndex = null;

      function openAnnEditModal(idx) {
        editingIndex = idx;
        const modal = document.getElementById('annEditModal');
        const input = document.getElementById('annModalInput');
        input.value = anns[idx];
        modal.setAttribute('aria-hidden', 'false');
        input.focus();
        input.select();
      }

      function closeAnnEditModal() {
        const modal = document.getElementById('annEditModal');
        modal.setAttribute('aria-hidden', 'true');
        editingIndex = null;
      }

      function saveAnnEdit() {
        const input = document.getElementById('annModalInput');
        if (editingIndex === null) return closeAnnEditModal();
        const val = input.value.trim();
        if (val) anns[editingIndex] = val;
        save(); render(); closeAnnEditModal();
      }

      function openAnnDeleteModal(idx) {
        deletingIndex = idx;
        const modal = document.getElementById('annDeleteModal');
        const msg = document.getElementById('annDeleteMessage');
        msg.textContent = `Delete announcement: "${anns[idx]}"?`;
        modal.setAttribute('aria-hidden', 'false');
      }

      function closeAnnDeleteModal() {
        const modal = document.getElementById('annDeleteModal');
        modal.setAttribute('aria-hidden', 'true');
        deletingIndex = null;
      }

      function confirmAnnDelete() {
        if (deletingIndex === null) return closeAnnDeleteModal();
        anns.splice(deletingIndex,1);
        save(); render(); closeAnnDeleteModal();
      }

      function render() {
        listEl.innerHTML = '';
        anns.forEach((a, idx) => {
          const li = document.createElement('li');
          const text = document.createElement('div'); text.textContent = a;
          const actions = document.createElement('div'); actions.className='announcement-actions';
          const edit = document.createElement('button'); edit.textContent='Edit'; edit.className='edit'; edit.addEventListener('click', () => openAnnEditModal(idx));
          const del = document.createElement('button'); del.textContent='Delete'; del.className='del'; del.addEventListener('click', () => openAnnDeleteModal(idx));
          actions.appendChild(edit); actions.appendChild(del);
          li.appendChild(text); li.appendChild(actions);
          listEl.appendChild(li);
        });
      }

      addBtn.addEventListener('click', () => {
        const v = input.value.trim(); if (!v) return; anns.unshift(v); input.value=''; save(); render();
      });
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') addBtn.click(); });

  load(); render();

  // wire announcement modals
  const annModal = document.getElementById('annEditModal');
  const annModalSave = document.getElementById('annModalSave');
  const annModalCancel = document.getElementById('annModalCancel');
  const annModalBackdrop = document.getElementById('annModalBackdrop');
  const annModalInput = document.getElementById('annModalInput');

  const annDeleteModal = document.getElementById('annDeleteModal');
  const annDeleteConfirm = document.getElementById('annDeleteConfirm');
  const annDeleteCancel = document.getElementById('annDeleteCancel');
  const annDeleteBackdrop = document.getElementById('annDeleteBackdrop');

  annModalSave.addEventListener('click', saveAnnEdit);
  annModalCancel.addEventListener('click', closeAnnEditModal);
  annModalBackdrop.addEventListener('click', closeAnnEditModal);
  annModalInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') saveAnnEdit(); else if (e.key === 'Escape') closeAnnEditModal(); });

  annDeleteConfirm.addEventListener('click', confirmAnnDelete);
  annDeleteCancel.addEventListener('click', closeAnnDeleteModal);
  annDeleteBackdrop.addEventListener('click', closeAnnDeleteModal);
    })();
  </script>
  <script>
    // Calendar Activities - month grid calendar
    (function(){
      const KEY = 'calendarActivities_v1';
      const calGrid = document.getElementById('calendarGrid');
      const calTitle = document.getElementById('calTitle');
      const calPrev = document.getElementById('calPrev');
      const calNext = document.getElementById('calNext');
      const eventsList = document.getElementById('eventsList');
      const selectedDateDisplay = document.getElementById('selectedDateDisplay');

      const titleEl = document.getElementById('eventTitle');
      const dateEl = document.getElementById('eventDate');
      const timeEl = document.getElementById('eventTime');
      const locEl = document.getElementById('eventLocation');
      const addBtn = document.getElementById('addEventBtn');
      const clearBtn = document.getElementById('clearEventsBtn');

      let viewDate = new Date(); // currently viewed month
      let selectedDate = null; // ISO yyyy-mm-dd

      function load(){ try{ return JSON.parse(localStorage.getItem(KEY)) || []; }catch(e){ return []; } }
      function save(items){ localStorage.setItem(KEY, JSON.stringify(items)); }
      function eventsForDay(iso){ return load().filter(e=>e.date===iso); }

      function isoOf(d){ const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const day=('0'+d.getDate()).slice(-2); return `${y}-${m}-${day}` }

      function renderMonth(){
        // header
        const monthName = viewDate.toLocaleString(undefined,{month:'long', year:'numeric'});
        calTitle.textContent = monthName;
        calGrid.innerHTML = '';

        // week day headers
        const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        days.forEach(d=>{ const h = document.createElement('div'); h.style.fontWeight='600'; h.style.padding='6px'; h.style.textAlign='center'; h.style.background='#fff'; h.textContent=d; calGrid.appendChild(h); });

        // first day of month
        const first = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
        const startIndex = first.getDay();
        const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 0).getDate();

        // fill blanks
        for(let i=0;i<startIndex;i++){ const blank = document.createElement('div'); blank.style.padding='12px'; blank.style.background='#fafafa'; calGrid.appendChild(blank); }

        // days
        for(let d=1; d<=daysInMonth; d++){
          const dt = new Date(viewDate.getFullYear(), viewDate.getMonth(), d);
          const iso = isoOf(dt);
          const cell = document.createElement('div');
          cell.style.minHeight='80px';
          cell.style.padding='8px';
          cell.style.borderRadius='6px';
          cell.style.background='#fff';
          cell.style.border='1px solid #eef3f6';
          cell.style.display='flex';
          cell.style.flexDirection='column';
          cell.style.justifyContent='flex-start';
          cell.style.cursor='pointer';

          const top = document.createElement('div'); top.style.display='flex'; top.style.justifyContent='space-between'; top.style.alignItems='center';
          const num = document.createElement('div'); num.style.fontWeight='600'; num.textContent = d;
          const badge = document.createElement('div'); badge.style.fontSize='12px'; badge.style.color='#666';
          top.appendChild(num); top.appendChild(badge);
          cell.appendChild(top);

          // event dots/preview
          const evs = eventsForDay(iso);
          if(evs.length){
            const list = document.createElement('div'); list.style.marginTop='6px'; list.style.display='flex'; list.style.flexDirection='column'; list.style.gap='4px';
            evs.slice(0,3).forEach(ev=>{ const e = document.createElement('div'); e.style.fontSize='12px'; e.style.background='#e8f5e9'; e.style.padding='4px 6px'; e.style.borderRadius='6px'; e.style.color='#0b8043'; e.textContent = (ev.time? ev.time + ' ':'') + ev.title; list.appendChild(e); });
            if(evs.length>3){ const more = document.createElement('div'); more.style.fontSize='12px'; more.style.color='#999'; more.textContent = `+${evs.length-3} more`; list.appendChild(more); }
            cell.appendChild(list);
          }

          // today highlight
          const todayIso = isoOf(new Date());
          if(iso === todayIso){ cell.style.boxShadow='0 2px 6px rgba(16,24,40,0.06)'; }

          // selected highlight
          if(selectedDate === iso){ cell.style.background='#eef6ff'; cell.style.border='1px solid #cfe6ff'; }

          cell.addEventListener('click', ()=>{ selectedDate = iso; // set date input to selected
            if(dateEl) dateEl.value = iso; renderMonth(); renderEventsForSelected(); });

          calGrid.appendChild(cell);
        }
      }

      function renderEventsForSelected(){
        eventsList.innerHTML = '';
        if(!selectedDate){ selectedDateDisplay.textContent = 'None'; eventsList.innerHTML = '<li class="empty" style="padding:8px;color:#666">Select a date to view events</li>'; return }
        selectedDateDisplay.textContent = selectedDate;
        const evs = eventsForDay(selectedDate);
        if(!evs.length){ eventsList.innerHTML = '<li class="empty" style="padding:8px;color:#666">No events for selected date</li>'; return }
        evs.slice().reverse().forEach((ev, idx)=>{
          const li = document.createElement('li'); li.style.display='flex'; li.style.justifyContent='space-between'; li.style.alignItems='center'; li.style.padding='8px'; li.style.borderRadius='6px'; li.style.background='#fbfdff'; li.style.border='1px solid #eef3f6'; li.style.marginBottom='8px';
          const left = document.createElement('div'); left.innerHTML = `<strong>${escapeHtml(ev.title)}</strong><div style="font-size:13px;color:#555">${ev.time?escapeHtml(ev.time)+' ‚Ä¢ ':' '}${escapeHtml(ev.location||'')}</div>`;
          const right = document.createElement('div');
          const del = document.createElement('button'); del.className='btn'; del.style.background='#e74c3c'; del.style.padding='6px 8px'; del.style.marginLeft='8px'; del.textContent='Delete';
          del.addEventListener('click', ()=>{ if(!confirm('Remove this event?')) return; let all = load(); // remove the matching event by createdAt
            all = all.filter(a=>!(a.date===selectedDate && a.createdAt===ev.createdAt)); save(all); renderMonth(); renderEventsForSelected(); });
          right.appendChild(del);
          li.appendChild(left); li.appendChild(right); eventsList.appendChild(li);
        });
      }

      function addEvent(){
        const title = (titleEl && titleEl.value || '').trim();
        const date = dateEl && dateEl.value || selectedDate || '';
        const time = timeEl && timeEl.value || '';
        const location = locEl && locEl.value.trim() || '';
        if(!title) { alert('Event title required'); if(titleEl) titleEl.focus(); return }
        if(!date) { alert('Event date required (select a date or use the date picker)'); if(dateEl) dateEl.focus(); return }
        const items = load();
        const rec = { title, date, time, location, createdAt: Date.now() };
        items.push(rec); save(items);
        if(titleEl) titleEl.value=''; if(timeEl) timeEl.value=''; if(locEl) locEl.value='';
        renderMonth(); renderEventsForSelected();
      }

      addBtn && addBtn.addEventListener('click', addEvent);
      clearBtn && clearBtn.addEventListener('click', ()=>{ if(!confirm('Clear all events?')) return; localStorage.removeItem(KEY); renderMonth(); renderEventsForSelected(); });

      calPrev && calPrev.addEventListener('click', ()=>{ viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()-1, 1); renderMonth(); });
      calNext && calNext.addEventListener('click', ()=>{ viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 1); renderMonth(); });

      // helper escape
      function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

      // initial
      // set date input default to today
      const todayIso = (new Date()).toISOString().slice(0,10);
      if(dateEl && !dateEl.value) dateEl.value = todayIso;
      selectedDate = todayIso;
      renderMonth(); renderEventsForSelected();
    })();
  </script>
 
  
</body>
</html>
